#+TITLE: Improving Portability and Interoperability of Deep-Learning-Workloads using ONNX
#+AUTHOR: Silin Zhao
#+STARTUP: overview
#+LATEX_HEADER: \usepackage[a4paper,text={6.25in,9in}, truedimen]{geometry}
#+LATEX_HEADER: \usepackage{minted}
* Thesis 
- First supervisor: Prof. Julian Kunkel
- Second supervisor: Dr. Sven Bingert
- Technical supervisor: Sadegh Keshtkar
- From 01.07.2024 to 02.01.2025

** Abstract
With the great achievement of AI has become a nonnegligible assistance for our daily activities, people are ready to expond its universal utilities for different applicable scenarios. We are going to research this problem by study the portability and interoperability of the ONNX file as middleware between different states of AI application in the context of FL. At first we will develop an AI model to predict the best suitable technical supporter for the new submitted question in a technical support system. With attention mechanism we can solve this supervised classification NLP task like a normal classification task and export it as an ONNX file. The core part of this thesis is to explore the portability and interoperability of our ONNX file with GPU and CPU in different kinds of runtime environments. We are going to measure the inferencing performance variant with respect to original model accuracy because of the degeneration of ONNX in different ONNX runtimes. Also we attempt to launch our ONNX file in different ONNX runtimes for on-device and resuming training for its time consumption and inferencing accuracy variante. Our task is to explore the maximum compatibility of ONNX file under different ONNX runtime environments, which is significant and beneficial for us to study FL.
* Research case
Since attention mechanism has been proposed in 2017, we have achieved unprecedented success in NLP. In this thesis we are going to use attention mechanism to develop a predict model so that we can select the best suitable agent for new submitted ticket in DWDG ticket system.

For our research case we have about 20000 historical ticket records which contains many kinds of questions about NHLN cluster in GÃ¶ttingen. We select only those records which has unique responsible person. For each of those records we use its communications as training data and extract its responsible person as training lable. The training data has to be preprocessed, i.e., all communication contents extracting, all contents concatenating, tokenization, vectoring. Data and label will be splited and saved as binary file.

After data has been generated, we want to develop an AI model to predict the best suitable technical supporter for the new submitted question in technical support system of GWDG. We assume that every case has been solved by a single supporter totally independently in the past. Based on the historical communications of each case with respect to its supporter, we will use the attention mechanism to understand the context meanings of those conversations, so that we can solve this supervised classification NLP task like a normal classification task. About the model construction we are going to use Transformer-Encoder. Because of our speical task we will implement it from scratch and manually fine-tune its complexity and performace. Attention mechanism will try to learn the content information from the data, so that our model try to understand which kinds of problem or topic have been mostly handed by which person. In this way our model will be ready to answer the question that which person is the best suitable candidant to deal with new submited ticket. When our model and data are both available, we will going to explore their super-parameters for time and accuracy performance.


As the next step after our model is well trained, we are going to improve its the portablility and interoperability with the ONNX format of our model.  Since ONNX can cover the gap between different deep learning frameworks, We attempt to execute our ONNX file for retraining with respect to time consumption variante and for inferencing with respect to accuracy variante in different ONNX runtimes. At first we export our model as ONNX file for inferencing and test its deteriorated performance because of the degeneration from ONNX. Next we will try to utilize our ONNX file for resuming and ondeviec training. In our thesis on-device has not to be always edge devices like handy, it can also be normal host or cloud machine. Our purpose is to seek the maximum universality of ONNX as intermedium between frameworks for re-training and inferencing. The universality of our ONNX file should be helpful for understanding and building a federated learning model for asimilar case just like in our thesis.

* Preprocess
** Data cleaning
*** Filter data
#+begin_center
responsible == onwer  $\neq$ niemand
#+end_center

For all ticket records, we select only such tickets when their /responsible/ and /onwer/ attributes are identical and not equal to niemand. Those usable data will be transfered to /singlehander/ folder, also the number of excluded tickets number will be printed out.

What is the exactly meaning and difference of /responsible/ and /onwer/  is still not clear, perhaps some tickets can still be used. Now we have totally 15578 tickets available.

*** Compose data
**** Target
We use /responsible/ as the target of data, so we extract them from each ticket and compose them as a list. The last step is to onehot code the list as binary format.
    
**** Content
In each tickte we have multiple conversations which can be distributed in many lines. We have to reconstruct all conversations and compose them as a list. In such list each item is a conversation, and each conversation will be pre-processed as following:
  - content concatenation
  - check is alpha
  - lower case
  - remove punctuation
  - remove apostrophe
  - remove stopwords(include names)
  - convert number to string
  - stemme germany
  - stemme english
*Important*: we have two requirments, conversation as content, OR only the first question as content. But the pre-processes are the same.
    
At the end, all elements of the list will be concatenated as a long string.

*** Staticstical study of contents length
After the composation of all tickets is done, we want have a glance about the length of their contents. The following foto show that
  - The words count of each ticket content
  - Histogram from the biggest words count to 0 with 300 bins
We see that there is a extremely large number (about 380000), and the rest are almost under 5000. We want to fit the histogram with gauss fitting, and try to find the right side of confendence interval for 95% confendence level. Because of the extremely long instance our gauss fitting doesn't work.


#+BEGIN_CENTER
#+ATTR_LaTeX: :height 0.65\textwidth :center
[[../results/wordscount/C0.png]]
#+END_CENTER

In order to exclude the extreme case, we cut the lenght off at 5000 for all data instances, the result shows as below,

#+BEGIN_CENTER
#+ATTR_LaTeX: :height 0.65\textwidth :center
[[../results/wordscount/C5000.png]]
#+END_CENTER
Gauss fitting works well for our histogram, and the right side of the confendence interval of confendence level at 95% for gauss fitted curve of words account at all conversation is 280. We use it to be the maximun allowed words length for vectoring. This number is special for our case based on all the data we have.


For further exploring, we want to set the cutoff to be 2000 to present our model with a smaller size, but this attempt has failed. Because of the complexity of gauss fitting, the maxfev default value (1000) is not enough to iterate to convergence.
 #+begin_src python
   import scipy
   scipy.curve_fit(..., maxfev=500000)
 #+end_src

After we assige new value to maxfex, we got error of OOM.
*** Words embedding
After we got all the content and the wanted vector size, the next step is word embeding by using Word2Vec in gensim package.
#+begin_src python
  model = Word2Vec(mydata, vector_size=280, window=5, min_count=1, sg=1, workers=8, epochs=5)
  mydata = [model.wv[mydata[i]] for i in range(mydata_len)]
  model.save(opt.w2v_model_path)
#+end_src
The output of Word2Vec is our training data, we already have the corresponding label before. Both will be saved as binary format for conveniency.

The last thing, we saved the word2vec model, if our model will be used for transfered learning or federated learning, new data have to be converted by this model.

** Vectoring
*** Data Partition 
- C: Conversation as content
For training our model, we use the whole conversation, and for validation, test and inference we also use the whole conversation. This approach can help us to vertify our assumption that supports answered the tickets which are appropriate for them based on their background and strength. Our model can learn the relationship mapping between ticket topics and supporters.  Those information can be helpful if we want to study the statistical contents of tickets.


- Q: First question as content
For training our model, we use the whole conversation, and for validation, test and inference we only use the first question. Because if we want to use  our model to predict the new submited ticket, we only have the first question available when new ticket has been submited. We are expecting a lower accuracy compare to having the whole conversation as validation, test and inference input. 

-  Randomization
Data will be serialized as unshuffled and shuffled with random seed. We are looking for a better performance with randomization, because the topic of tickets can be seasonal, this has impact for performance.


#+ATTR_LATEX: :font \scriptsize
|------------+--------------+--------------+--------------+---------------+----------------|
| percentage | train data   | valid data   | test data    | ondevice data | inference data |
|------------+--------------+--------------+--------------+---------------+----------------|
| 40         | 40%          | 10%          | 0            | 40%           | 10%            |
| C(input)   | conversation | conversation | non          | conversation  | conversation   |
| Q(input)   | conversation | question     | non          | conversation  | question       |
| lable      | owner        | owner        | non          | owner         | owner          |
|------------+--------------+--------------+--------------+---------------+----------------|
| 60         | 60%          | 10%          | 10%          | 10%           | 10%            |
| C(input)   | conversation | conversation | conversation | conversation  | conversation   |
| Q(input)   | conversation | conversation | conversation | conversation  | conversation   |
| lable      | owner        | owner        | owner        | owner         | owner          |
|------------+--------------+--------------+--------------+---------------+----------------|
| 90         | 90%          | 10%          | 0            | 0             | 0              |
| C(input)   | conversation | conversation | non          | non           | non            |
| Q(input)   | conversation | question     | non          | non           | non            |
| label      | owner        | owner        | non          | non           | non            |
|------------+--------------+--------------+--------------+---------------+----------------|

*** Data remove
Data have been saved in /mnt/lustre-emmy-hdd/usr/u11656/silin_onnx
*** Check train data identity between conversation and question
#+attr_latex: :options framesep=2mm, baselinestretch=1.2, linenos, fontsize=\footnotesize, breaklines=true, bgcolor=bg, style=xcode
#+begin_src sh
  if cmp --silent -- "file1" "file2"; then
      echo "files contents are identical";
  else
      echo "files differ";
  fi 
#+end_src
As show in the table upper, all set should be identical except  conversation/ *question*.


Should be true
#+attr_latex: :options framesep=2mm, baselinestretch=1.2, linenos, fontsize=\footnotesize, breaklines=true, bgcolor=bg, style=xcode
#+begin_src sh
 if cmp --silent -- "./40_conversation_Data_host_train" "./40_question_Data_host_train"; then
      echo "files contents are identical";
 else
      echo "files differ";
 fi
#+end_src

Should be false
#+attr_latex: :options framesep=2mm, baselinestretch=1.2, linenos, fontsize=\footnotesize , breaklines=true, bgcolor=bg, style=xcode
#+begin_src sh
 if cmp --silent -- "./40_conversation_Data_host_valid" "./40_question_Data_host_valid"; then
      echo "files contents are identical";
 else
      echo "files differ";
 fi
#+end_src

** Parameter exploring training
We explore the accuracy and time performance of  learning rate, batch size, number of heads and layers for question and conversation. In order to have a global overview of performance, we train 300 epochs(certainly overfitted) and note the best accurary.
Here we use 60 percent  training set for question and conversation
*** Batch size
#+begin_export latex
\begin{minted}[escapeinside=||,mathescape=true]{text}
|vector size: $V$ =  512|
|multihead: $M$ = 1|
|layers: $L$ = 2|
|learning rate: $R$ = 0.00000001|
|batchsize: $B$ = [1, 2, 4, 8, 16, 32, 64]|
|$\textbf{\textit{batch size exploring}}$|(train_data, train_label, valid_data, valid_label):
for batchsize b in B do:
    model.initialise()
    for epoch n = 1, 2,...300 do:
        model.train(train_data, train_label)
            |$w_{n+1}^{b} \gets Update(w_{n}^{b})$|
        accuracy |$\gets$| model.valid(valid_data, valid_label)
        Accuracy.append(accuracy)
    Acc |$\Leftarrow$| max (Accuracy)
    Time |$\Leftarrow$| time comsumption
\end{minted}
#+end_export

#+tags: Epochs: 300
#+tags: Vector size: 512
#+tags: Multihead 1
#+tags: Layers: 2
#+tags: Learning rate: 0.00000001
#+ATTR_LATEX: :font \scriptsize
#+tblname: ForBatchSize-R1e-8-multihead1-layers2-table-question
| batch size | TimeQ |  AccQ | TimeC |  AccC |
|------------+-------+-------+-------+-------|
|          1 |   377 | 0.154 |   275 | 0.301 |
|          2 |   193 | 0.141 |   157 | 0.265 |
|          4 |   108 | 0.133 |   110 | 0.215 |
|          8 |    67 | 0.099 |    75 | 0.192 |
|         16 |    58 | 0.096 |    65 | 0.166 |
|         32 |    55 | 0.102 |    53 | 0.148 |
|         64 |    48 | 0.094 |    54 | 0.123 |

#+begin_src gnuplot :var data=ForBatchSize-R1e-8-multihead1-layers2-table-question :file ../results/images/ForBatchSize-R1e-8-multihead1-layers2-Nolog.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600
  set title "Accuracy and time consumption change with respect to batch size"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 12"
  set key at graph 0.45, 1.0
  # set logscale x 2

  set xlabel "{/:Italic Batch size} [learning rate:1e-8, Multihead:1, Layers:2]" font ",16" 
  set xtics nomirror rotate by -20  font ", 12" 

  set yrange [0:400]
  set ytics textcolor rgb "#0000dd"
  set ylabel "Time comsumption in minutes" font ",14" textcolor rgb "#0000dd"
  set ytics nomirror rotate by -45 font ", 12"  


  set y2range [0:0.7]
  set y2label "Accurary" font ",14" offset +2,0 textcolor rgb "#dd181f"
  set y2tics nomirror  rotate by +25 font ", 12"
  set y2tics textcolor rgb "#dd181f"

  set style data lines
  plot  data u 1:2:xticlabels(1) with lp axis x1y1 lt 1 dashtype 3 lw 3 lc rgb '#0000dd' ps 1.5  pt 9  title 'Time question', \
        data u 1:3:xticlabels(1) with lp axis x1y2 lt 1 dashtype 3 lw 3 lc rgb '#dd181f' ps 1.5  pt 9  title 'Accuracy question',\
        data u 1:4:xticlabels(1) with lp axis x1y1 lt 1 dashtype 1 lw 2 lc rgb '#0000dd' ps 1    pt 7  title 'Time conversation', \
        data u 1:5:xticlabels(1) with lp axis x1y2 lt 1 dashtype 1 lw 2 lc rgb '#dd181f' ps 1    pt 7  title 'Accuracy conversation'
#+end_src

#+RESULTS:
[[file:../results/images/ForBatchSize-R1e-8-multihead1-layers2-Nolog.png]]

#+ATTR_LATEX:  :scale 0.35
[[file:../results/images/ForBatchSize-R1e-8-multihead1-layers2.png]]

We explore batch size from  1 to 64 for question(dotted line) and conversation(solid line). Blue for the time consumpton on the left, and red for accuracy on the right. With batch size from 1 to 64 we can see time consumption and accuracy both clearly decreased.
We set *Batch size* to be 1.

*** Learning rate
#+begin_export latex
\begin{minted}[escapeinside=||,mathescape=true]{text}
|vector size: $V$ =  512|
|multihead: $M$ = 1|
|layers: $L$ = 2|
|batchsize: $B$ = 1|
|learning rate: $R$ = [0.00000001, 0.00000002 ,0.00000005, 0.0000001, |
                      |0.0000002, 0.0000005, 0.000001, 0.000002]|
|$\textbf{\textit{learning rate exploring}}$|(train_data, train_label, valid_data, valid_label):
for learning rate r in R do:
    model.initialise()
    for epoch n = 1, 2,...300 do:
        model.train(train_data, train_label)
            |$w_{n+1}^{r} \gets Update(w_{n}^{r})$|
        accuracy |$\gets$| model.valid(valid_data, valid_label)
        Accuracy.append(accuracy)
    Acc |$\Leftarrow$| max (Accuracy)
    Time |$\Leftarrow$| time comsumption
\end{minted}
#+end_export
#+tags: Epochs: 300
#+tags: Vector size: 512
#+tags: Multihead 1
#+tags: Layers: 2
#+tags: batch-size: 1
#+ATTR_LATEX: :font \scriptsize
#+tblname: ForLearningRate-batchsize1-multihead1-layers2-table
|          R | MinutesQ |  AccQ | MinutesC |  AccC |
|------------+----------+-------+----------+-------|
| 0.00000001 |      377 | 0.154 |      275 | 0.301 |
| 0.00000002 |      312 | 0.163 |      302 | 0.332 |
| 0.00000005 |      311 | 0.166 |      291 | 0.347 |
|  0.0000001 |      306 | 0.188 |      298 | 0.372 |
|  0.0000002 |      312 | 0.189 |      291 | 0.478 |
|  0.0000005 |      293 | 0.202 |      297 | 0.563 |
|   0.000001 |      337 | 0.178 |      430 | 0.599 |
|   0.000002 |      309 | 0.188 |      436 | 0.627 |


#+begin_src gnuplot :var data=ForLearningRate-batchsize1-multihead1-layers2-table :missing "?" :file ../results/images/ForLearningRate-batchsize1-multihead1-layers2.png  :exports none
  reset
  set terminal pngcairo enhanced size 800,600

  set title "Accuracy and time consumption change with respect to learning rate"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 12"
  set key at graph 0.45, 1.0
  set logscale x 2

  set xlabel "{/:Italic Learning rate}  [Batch size:1, Multihead:1, Layers:2]" font ",16" 
  set xtics nomirror rotate by -20  font ", 12" 

  set yrange [0:700]
  set ytics textcolor rgb "#0000dd"
  set ylabel "Time comsumption in minutes" font ",14" textcolor rgb "#0000dd"
  set ytics nomirror rotate by -45 font ", 12"  


  set y2range [0:0.7]
  set y2label "Accurary" font ",14" offset +2,0 textcolor rgb "#dd181f"
  set y2tics nomirror  rotate by +25 font ", 12"
  set y2tics textcolor rgb "#dd181f"

  set style data lines
  plot  data u 1:2:xticlabels(1) with lp axis x1y1 lt 1 dashtype 3 lw 3 lc rgb '#0000dd' ps 1.5  pt 9  title 'Time question', \
        data u 1:3:xticlabels(1) with lp axis x1y2 lt 1 dashtype 3 lw 3 lc rgb '#dd181f' ps 1.5  pt 9  title 'Accuracy question',\
        data u 1:4:xticlabels(1) with lp axis x1y1 lt 1 dashtype 1 lw 2 lc rgb '#0000dd' ps 1    pt 7  title 'Time conversation', \
        data u 1:5:xticlabels(1) with lp axis x1y2 lt 1 dashtype 1 lw 2 lc rgb '#dd181f' ps 1    pt 7  title 'Accuracy conversation'
#+end_src

#+RESULTS:
[[file:../results/images/ForLearningRate-batchsize1-multihead1-layers2.png]]

#+ATTR_LATEX:  :scale 0.35
[[file:../results/images/ForLearningRate-batchsize1-multihead1-layers2.png]]

Learning rate has less impact on time consumption, no matter for question and conversation, the time consumption vibrate in a very small range. But for accuracy, we have the best performance for *Batch size = 0.0000005*.

*** Multiheads
#+begin_export latex
\begin{minted}[escapeinside=||,mathescape=true]{text}
|vector size: $V$ =  512|
|layers: $L$ = 2|
|batchsize: $B$ = 1|
|learning rate: $R$ = 0.000005|
|multihead: $M$ = [1, 2, 4, 8]|
|$\textbf{\textit{Multiheads exploring}}$|(train_data, train_label, valid_data, valid_label):
for multihead m in M do:
    model.initialise()
    for epoch n = 1, 2,...300 do:
        model.train(train_data, train_label)
            |$w_{n+1}^{m} \gets Update(w_{n}^{m})$|
        accuracy |$\gets$| model.valid(valid_data, valid_label)
        Accuracy.append(accuracy)
    Acc |$\Leftarrow$| max (Accuracy)
    Time |$\Leftarrow$| time comsumption
\end{minted}
#+end_export
#+tags: Epochs: 300
#+tags: Vector size: 512
#+tags: Layers: 2
#+tags: Learning rate: 0.0000005
#+tags: batch-size 1
#+ATTR_LATEX: :font \scriptsize
#+tblname: ForMultihead-R5e-7-batchsize1-layers2-table
| multihead | MinutesQ |  AccQ | MinutesC |  AccC |
|-----------+----------+-------+----------+-------|
|         1 |      293 | 0.202 |      297 | 0.563 |
|         2 |      318 | 0.180 |      293 | 0.433 |
|         4 |      320 | 0.182 |      299 | 0.385 |
|         8 |      321 | 0.180 |      320 | 0.369 |

#+begin_src gnuplot :var data=ForMultihead-R5e-7-batchsize1-layers2-table :file ../results/images/ForMultihead-R5e-7-batchsize1-layers2.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600

  set title "Accuracy and time consumption change with respect to the number of heads"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 12"
  set key at graph 0.45, 1.0

  set xlabel "{/:Italic Number of heads} [Batch size:1, Learning rate:5e-7, Layers:2]" font ",16" 
  set xtics nomirror rotate by -20  font ", 12" 

  set yrange [0:700]
  set ytics textcolor rgb "#0000dd"
  set ylabel "Time comsumption in minutes" font ",14" textcolor rgb "#0000dd"
  set ytics nomirror rotate by -45 font ", 12"  


  set y2range [0:0.7]
  set y2label "Accurary" font ",14" offset +2,0 textcolor rgb "#dd181f"
  set y2tics nomirror  rotate by +25 font ", 12"
  set y2tics textcolor rgb "#dd181f"

  set style data lines
  plot  data u 1:2:xticlabels(1) with lp axis x1y1 lt 1 dashtype 3 lw 3 lc rgb '#0000dd' ps 1.5  pt 9  title 'Time question', \
        data u 1:3:xticlabels(1) with lp axis x1y2 lt 1 dashtype 3 lw 3 lc rgb '#dd181f' ps 1.5  pt 9  title 'Accuracy question',\
        data u 1:4:xticlabels(1) with lp axis x1y1 lt 1 dashtype 1 lw 2 lc rgb '#0000dd' ps 1    pt 7  title 'Time conversation', \
        data u 1:5:xticlabels(1) with lp axis x1y2 lt 1 dashtype 1 lw 2 lc rgb '#dd181f' ps 1    pt 7  title 'Accuracy conversation'
  #+end_src

  #+RESULTS:
  [[file:../results/images/ForMultihead-R5e-7-batchsize1-layers2.png]]

#+ATTR_LATEX:  :scale 0.35
[[file:../results/images/ForMultihead-R5e-7-batchsize1-layers2.png]]

The number of multihead is a hyper-parameter in transformer encoder. In NLP task, multiheads comput and merge attention scores in parallel, connections and differences in sequences can be captured in greater detail, resulting in better representation of the meaning and associations of contents. But for our classification task, no matter for conversaton or question, single head has better performance. With the increasing of multihead, the accuracy get more worse. So we set *Multihead = 1*.

*** Layers
#+begin_export latex
\begin{minted}[escapeinside=||,mathescape=true]{text}
|vector size: $V$ =  512|
|batchsize: $B$ = 1|
|learning rate: $R$ = 0.000005|
|multihead: $M$ = 1|
|layers: $L$ = [1, 2, 3, 4]|
|$\textbf{\textit{Layers exploring}}$|(train_data, train_label, valid_data, valid_label):
for layer l in L do:
    model.initialise()
    for epoch n = 1, 2,...300 do:
        model.train(train_data, train_label)
            |$w_{n+1}^{l} \gets Update(w_{n}^{l})$|
        accuracy |$\gets$| model.valid(valid_data, valid_label)
        Accuracy.append(accuracy)
    Acc |$\Leftarrow$| max (Accuracy)
    Time |$\Leftarrow$| time comsumption
\end{minted}
#+end_export
#+tags: Epochs: 300
#+tags: Vector size: 512
#+tags: Multihead 1
#+tags: Batch size 1
#+tags: Learning rate: 0.0000005
#+ATTR_LATEX: :font \scriptsize
#+tblname: ForLayers-R5e-7-batchsize1-multihead1-table
| Layers | MinutesQ |  AccQ | MinutesC |  AccC |
|--------+----------+-------+----------+-------|
|      1 |      235 | 0.177 |      155 | 0.353 |
|      2 |      293 | 0.202 |      297 | 0.563 |
|      3 |      411 | 0.192 |      435 | 0.566 |
|      4 |      631 | 0.202 |      636 | 0.606 |


#+begin_src gnuplot :var data=ForLayers-R5e-7-batchsize1-multihead1-table :file ../results/images/ForLayers-R5e-7-batchsize1-multihead1-table.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600

  set title "Accuracy and time consumption change with respect to the number of layers"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 12"
  set key at graph 0.45, 1.0

  set xlabel "{/:Italic Number of layers} [Batch size:1, Learning rate:5e-7, Multihead:1]" font ",16" 
  set xtics nomirror rotate by -20  font ", 12" 

  set yrange [0:700]
  set ytics textcolor rgb "#0000dd"
  set ylabel "Time comsumption in minutes" font ",14" textcolor rgb "#0000dd"
  set ytics nomirror rotate by -45 font ", 12"  


  set y2range [0:0.7]
  set y2label "Accurary" font ",14" offset +2,0 textcolor rgb "#dd181f"
  set y2tics nomirror  rotate by +25 font ", 12"
  set y2tics textcolor rgb "#dd181f"

  set style data lines
  plot  data u 1:2:xticlabels(1) with lp axis x1y1 lt 1 dashtype 3 lw 3 lc rgb '#0000dd' ps 1.5  pt 9  title 'Time question', \
        data u 1:3:xticlabels(1) with lp axis x1y2 lt 1 dashtype 3 lw 3 lc rgb '#dd181f' ps 1.5  pt 9  title 'Accuracy question',\
        data u 1:4:xticlabels(1) with lp axis x1y1 lt 1 dashtype 1 lw 2 lc rgb '#0000dd' ps 1    pt 7  title 'Time conversation', \
        data u 1:5:xticlabels(1) with lp axis x1y2 lt 1 dashtype 1 lw 2 lc rgb '#dd181f' ps 1    pt 7  title 'Accuracy conversation'

#+end_src

#+ATTR_LATEX:  :scale 0.35
[[file:../results/images/ForLayers-R5e-7-batchsize1-multihead1-table.png]]

Number of layers in transformer encoder determine its complexity. Less complex model is more likely to be overfited. For our supervised  classification task, we expect  the most appropriate complexity to comprehend the our training input, while not to be overfitted. For only 1 layer we can see very soon overfitting for training(no image here yet).

As displayed in figure, for conversation, more laysers can offer us higher accuracy for validation. However for question, we do not gain better accuracy for increase the number of layers after it's bigger than 2. In order to consider both case, we choose *Layer = 4*.

*** Q summary
#+ATTR_LATEX: :font \scriptsize
#+tblname: summary-with-question
|   | batch size |   Acc |          R |   Acc | multihead |   Acc | Layers |   Acc |  best |
|---+------------+-------+------------+-------+-----------+-------+--------+-------+-------|
| 1 |          1 | 0.154 | 0.00000001 | 0.154 |           |       |        |       |       |
| 2 |          2 | 0.141 | 0.00000002 | 0.163 |           |       |        |       |       |
| 3 |          4 | 0.133 | 0.00000005 | 0.166 |           |       |        |       |       |
| 4 |          8 | 0.099 |  0.0000001 | 0.188 |           |       |        |       |       |
| 5 |         16 | 0.096 |  0.0000002 | 0.189 |           |       |      1 | 0.177 |       |
| 6 |         32 | 0.102 |  0.0000005 | 0.202 |         1 | 0.202 |      2 | 0.202 | 0.202 |
| 7 |         64 | 0.094 |   0.000001 | 0.178 |         2 | 0.180 |      3 | 0.192 |       |
| 8 |            |       |   0.000002 | 0.188 |         3 | 0.182 |      4 | 0.202 |       |
| 9 |            |       |            |       |         4 | 0.180 |        |       |       |


#+begin_src gnuplot :var data=summary-with-question :missing "?"  :file ~/Desktop/summary-with-question.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600 

  set title "Accuracy exploring summary for hyper-parameters with question"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 12"
  set key at graph 0.85, 1.0
  set key textcolor variable

  set xlabel "{/:Italic Account}" font ",14" 
  set xtics nomirror rotate by -45  font ", 12" 

  set yrange [0.05:0.25]
  set ylabel "Accuracy" font ",14"
  set ytics nomirror rotate by -45 font ", 12"  

  set style data lines
  plot  data u 1:3 with lp axis x1y1 lt 1 lw 0.5 lc rgb '#000000' ps 1.5  pt 3  title 'Batch size for Learning Rate=1e-8, Multihead=1, Layers=2',\
        data u 1:3:(sprintf('%d', $2)) notitle with labels offset char 1,-1 tc rgb '#000000' ,\
        data u 1:5 with lp axis x1y1 lt 1 lw 0.5 lc rgb '#0000ff' ps 1  pt 7  title 'Learning rate for       Batch Size=1, Multihead=1, Layers=2', \
        data u 1:5:(sprintf('%.8g', $4)) notitle with labels offset char 2.2,1 tc rgb '#0000ff' ,\
        data u 1:7 with lp axis x1y1 lt 1 lw 1   lc rgb '#0077ff' ps 1  pt 4  title 'Mutlihead for Batch Size=1, Learning Rate=5e-7, Layers=2',\
        data u 1:7:(sprintf('%d', $6)) notitle with labels offset char 1,-1  tc rgb '#0077ff'  ,\
        data u 1:9 with lp axis x1y1 lt 1 lw 1   lc rgb '#ff0000' ps 1  pt 5  title 'Layers for Batch Size=1, Learning Rate=5e-7, Multihead=1' ,\
        data u 1:9:(sprintf('%d', $8)) notitle with labels offset char -0.7, 0.7 tc rgb '#ff0000'
#+end_src

#+RESULTS:
[[file:~/Desktop/summary-with-question.png]]

#+ATTR_LATEX:  :scale 0.35
[[file:../results/images/summary-with-question.png]]

*** C summary

#+ATTR_LATEX: :font \scriptsize
#+tblname: summary-with-conversation
|   | batch size |   Acc |          R |   Acc | multihead |   Acc | Layers |   Acc |
|---+------------+-------+------------+-------+-----------+-------+--------+-------|
| 1 |          1 | 0.301 | 0.00000001 | 0.301 |           |       |        |       |
| 2 |          2 | 0.265 | 0.00000002 | 0.332 |           |       |        |       |
| 3 |          4 | 0.215 | 0.00000005 | 0.347 |           |       |        |       |
| 4 |          8 | 0.192 |  0.0000001 | 0.372 |           |       |        |       |
| 5 |         16 | 0.166 |  0.0000002 | 0.478 |           |       |      1 | 0.353 |
| 6 |         32 | 0.148 |  0.0000005 | 0.563 |         1 | 0.563 |      2 | 0.563 |
| 7 |         64 | 0.123 |   0.000001 | 0.599 |         2 | 0.433 |      3 | 0.566 |
| 8 |        128 | 0.117 |   0.000002 | 0.627 |         4 | 0.385 |      4 | 0.606 |
| 9 |            |       |            |       |         8 | 0.369 |        |       |


#+begin_src gnuplot :var data=summary-with-conversation :missing "?"  :file ~/Desktop/summary-with-conversation.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600 

  set title "Accuracy exploring summary for hyper-parameters with conversation"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 12"
  set key at graph 0.80, 1.0
  set key textcolor variable

  set xlabel "{/:Italic Account}" font ",14" 
  set xtics nomirror rotate by -45  font ", 12" 

  set yrange [0.05:0.75]
  set ylabel "Accuracy" font ",14"
  set ytics nomirror rotate by -45 font ", 12"  

  set style data lines
  plot  data u 1:3 with lp axis x1y1 lt 1 lw 0.5 lc rgb '#000000' ps 1.5  pt 3  title 'Batch size for Learning Rate=1e-8, Multihead=1, Layers=2',\
        data u 1:3:(sprintf('%d', $2)) notitle with labels offset char 1,-1  tc rgb '#000000' ,\
        data u 1:5 with lp axis x1y1 lt 1 lw 0.5 lc rgb '#0000ff' ps 1  pt 7  title 'Learning rate for       Batch Size=1, Multihead=1, Layers=2', \
        data u 1:5:(sprintf('%.8g', $4)) notitle with labels offset char 2.2,1 tc rgb '#0000ff' ,\
        data u 1:7 with lp axis x1y1 lt 1 lw 1   lc rgb '#0077ff' ps 1  pt 4  title 'Mutlihead for Batch Size=1, Learning Rate=5e-7, Layers=2',\
        data u 1:7:(sprintf('%d', $6)) notitle with labels offset char -1,-0.2  tc rgb '#0077ff',\
        data u 1:9 with lp axis x1y1 lt 1 lw 1   lc rgb '#ff0000' ps 1  pt 5  title 'Layers for Batch Size=1, Learning Rate=5e-7, Multihead=1' ,\
        data u 1:9:(sprintf('%d', $8)) notitle with labels offset char 1,-1 tc rgb '#ff0000'

#+end_src

#+RESULTS:
[[file:~/Desktop/summary-with-conversation.png]]

#+ATTR_LATEX:  :scale 0.35
[[file:../results/images/summary-with-conversation.png]]

** Exponding training set
We train our model for 200 epochs and display the overfitting for different training set(40, 60, 90). We are expecting a better performance for larger training set. The same should for unshuffled data compare to  shuffled data.
**** Unshuffle
#+BEGIN_CENTER
#+ATTR_LaTeX: :height 0.33\textwidth :center
 [[../results/overfit/unshuffle_plot_overfitting.png]]
#+END_CENTER

**** Shuffle
#+BEGIN_CENTER
#+ATTR_LaTeX: :height 0.33\textwidth :center
[[../results/overfit/shuffle_plot_overfitting.png]]
#+END_CENTER

For unshuffled data and shuffled data, we see very similar phenomenon. With more data(90 percent) we have a better accuracy and loss performance and need less training. If training goes on, overfiting comes soon.

When we decrease our training data, i.e., with 60 percent or 40 percent, the corresponding accuracy and loss performances less well, and the overfitting comes also slowly.

* Pytorch
** Workflow
#+BEGIN_CENTER
#+ATTR_LaTeX: :height 0.50\textwidth :center
[[../results/process/Process_Pytorch.drawio.png]]
#+END_CENTER
** Algo
*** Pytorch training
#+begin_export latex
\begin{minted}[escapeinside=||,mathescape=true]{text}
|vector size: $V$ =  512|
|multihead: $M$ = 1|
|layers: $L$ = 4|
|learning rate: $R$ = 0.0000005|
|batchsize: $B$ = 1|
|evaluation: question|
|train set persentage: 60|
|device: [cpu, gpu]|
|$\textbf{\textit{training}}$|(train_data, train_label, valid_data, valid_label):
    model.initialise()
    for epoch n = 1, 2,...20 do:
        model.train(train_data, train_label)
            |$w_{n+1} \gets Update(w_{n})$|
        accuracy |$\gets$| model(valid_data, valid_label)
        Accuracy.append(accuracy)
    Acc |$\Leftarrow$| max (Accuracy)
    Time |$\Leftarrow$| time comsumption
    model_state |$\Leftarrow$| model
    model_whole |$\Leftarrow$| model
    check_points |$\Leftarrow$| model
\end{minted}
#+end_export

*** Pytorch Resuming training
#+begin_export latex
\begin{minted}[escapeinside=||,mathescape=true]{text}
|$\textbf{\textit{Pytorch resume training}}$|(train_data, train_label, valid_data, valid_label):
    model.initialise()
    model_parameter |$\gets$| check_points
    model.load(model_parameter)
    accuracy_before_resuming_training |$\gets$| model(valid_data, valid_label)
    Time |$\Leftarrow$| time comsumption
    for epoch n = 21, 11,...40 do:
        accuracy |$\gets$| model(train_data, train_label)
            |$w_{n+1} \gets Update(w_{n})$|
        Accuracy.apend(accuracy)
    Acc |$\Leftarrow$| max(Accuracy)
    Time |$\Leftarrow$| time comsumption
    model_state_resuming |$\Leftarrow$| model
    model_whole_resuming |$\Leftarrow$| model
    check_points_resuming |$\Leftarrow$| model
\end{minted}
#+end_export
*** Pytorch Ondevice training
#+begin_export latex
\begin{minted}[escapeinside=||,mathescape=true]{text}
|$\textbf{\textit{ondevice training}}$|(ondevice_data, ondevice_label, valid_data, valid_label):
    model.initialise()
    model_parameter |$\gets$| check_points
    model.load(model_parameter)
    accuracy_before_resuming_training |$\gets$| model(valid_data, valid_label)
    Time |$\Leftarrow$| time comsumption
    for epoch n = 21, 11,...40 do:
        accuracy |$\gets$| model(train_data, train_label)
            |$w_{n+1} \gets Update(w_{n})$|
        Accuracy.apend(accuracy)
    Acc |$\Leftarrow$| max(Accuracy)
    Time |$\Leftarrow$| time comsumption
    model_state_ondevice |$\Leftarrow$| model
    model_whole_ondevice |$\Leftarrow$| model
    check_points_ondevice |$\Leftarrow$| model
\end{minted}
#+end_export

*** Pytorch test
#+begin_export latex
\begin{minted}[escapeinside=||,mathescape=true]{text}
|$\textbf{\textit{pytroch testing}}$|(test_data, test_label):
    model.initialise()
    for model_parameter in [model_state, model_whole, check_points] do:
        model.load(model_parameter)
        accuracy |$\Leftarrow$| model(test_data, test_label)
        Time |$\Leftarrow$| time comsumption
\end{minted}
#+end_export

** Portability
#+tblname: Process-Pytorch-Portability
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|
|  0 | resume40 | resume60 | resume40 | ondevice40 | resume60 | ondevice60 | resume40 | ondevice40 | resume60 | ondevice60 |
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|
|  1 |   3.5328 |   3.4151 |          |            |          |            |          |            |          |            |
|  2 |   3.3647 |   3.2222 |          |            |          |            |          |            |          |            |
|  3 |   3.2477 |   3.0831 |          |            |          |            |          |            |          |            |
|  4 |   3.1476 |   2.9745 |          |            |          |            |          |            |          |            |
|  5 |   3.0698 |    2.886 |          |            |          |            |          |            |          |            |
|  6 |   2.9999 |   2.8116 |          |            |          |            |          |            |          |            |
|  7 |   2.9424 |   2.7564 |          |            |          |            |          |            |          |            |
|  8 |   2.8879 |   2.7022 |          |            |          |            |          |            |          |            |
|  9 |   2.8472 |   2.6616 |          |            |          |            |          |            |          |            |
| 10 |   2.8106 |   2.6215 |          |            |          |            |          |            |          |            |
| 11 |   2.7817 |   2.5882 |          |            |          |            |          |            |          |            |
| 12 |   2.7524 |   2.5601 |          |            |          |            |          |            |          |            |
| 13 |   2.7279 |   2.5314 |          |            |          |            |          |            |          |            |
| 14 |   2.7061 |    2.504 |          |            |          |            |          |            |          |            |
| 15 |   2.6898 |   2.4856 |          |            |          |            |          |            |          |            |
| 16 |    2.672 |   2.4596 |          |            |          |            |          |            |          |            |
| 17 |   2.6537 |   2.4428 |          |            |          |            |          |            |          |            |
| 18 |   2.6401 |   2.4241 |          |            |          |            |          |            |          |            |
| 19 |    2.627 |   2.4028 |          |            |          |            |          |            |          |            |
| 20 |   2.6137 |   2.3902 |          |            |          |            |          |            |          |            |
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|
| 21 |          |          |    2.604 |     2.5701 |   2.3743 |     2.3923 |          |            |          |            |
| 22 |          |          |    2.594 |     2.5178 |   2.3595 |     2.3914 |          |            |          |            |
| 23 |          |          |    2.587 |     2.4778 |   2.3438 |     2.3901 |          |            |          |            |
| 24 |          |          |    2.571 |     2.4468 |   2.3304 |     2.3858 |          |            |          |            |
| 25 |          |          |    2.565 |     2.4224 |    2.315 |     2.3828 |          |            |          |            |
| 26 |          |          |    2.559 |     2.3974 |   2.3011 |     2.3801 |          |            |          |            |
| 27 |          |          |    2.552 |      2.374 |   2.2906 |     2.3789 |          |            |          |            |
| 28 |          |          |    2.543 |     2.3518 |    2.272 |     2.3864 |          |            |          |            |
| 29 |          |          |    2.536 |     2.3336 |   2.2628 |     2.3772 |          |            |          |            |
| 30 |          |          |    2.530 |     2.3177 |   2.2462 |     2.3787 |          |            |          |            |
| 31 |          |          |    2.525 |     2.3066 |   2.2311 |     2.3762 |          |            |          |            |
| 32 |          |          |    2.518 |     2.2927 |   2.2154 |     2.3794 |          |            |          |            |
| 33 |          |          |    2.511 |     2.2795 |   2.2005 |     2.3818 |          |            |          |            |
| 34 |          |          |    2.508 |     2.2639 |   2.1825 |     2.3773 |          |            |          |            |
| 35 |          |          |    2.503 |     2.2535 |   2.1678 |     2.3801 |          |            |          |            |
| 36 |          |          |    2.499 |     2.2432 |   2.1453 |     2.3849 |          |            |          |            |
| 37 |          |          |    2.491 |      2.232 |   2.1322 |     2.3818 |          |            |          |            |
| 38 |          |          |    2.489 |     2.2149 |   2.1106 |      2.389 |          |            |          |            |
| 39 |          |          |    2.483 |     2.2027 |   2.0878 |     2.3875 |          |            |          |            |
| 40 |          |          |    2.479 |     2.1967 |   2.0721 |     2.3935 |          |            |          |            |
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|
| 41 |          |          |          |            |          |            |    2.476 |     2.1825 |   2.0521 |     2.3924 |
| 42 |          |          |          |            |          |            |    2.472 |     2.1723 |   2.0323 |     2.3955 |
| 43 |          |          |          |            |          |            |    2.464 |     2.1577 |   2.0095 |     2.3971 |
| 44 |          |          |          |            |          |            |    2.462 |     2.1433 |   1.9894 |     2.4013 |
| 45 |          |          |          |            |          |            |     2.46 |     2.1309 |   1.9704 |     2.4022 |
| 46 |          |          |          |            |          |            |    2.458 |     2.1169 |   1.9518 |     2.4034 |
| 47 |          |          |          |            |          |            |    2.448 |     2.1002 |   1.9352 |     2.4061 |
| 48 |          |          |          |            |          |            |    2.450 |     2.0884 |   1.9204 |     2.4096 |
| 49 |          |          |          |            |          |            |    2.443 |     2.0689 |   1.9065 |     2.4094 |
| 50 |          |          |          |            |          |            |    2.442 |     2.0529 |    1.892 |     2.4134 |
| 51 |          |          |          |            |          |            |    2.435 |     2.0409 |   1.8796 |     2.4177 |
| 52 |          |          |          |            |          |            |    2.435 |     2.0262 |   1.8676 |     2.4174 |
| 53 |          |          |          |            |          |            |    2.430 |     2.0106 |   1.8536 |      2.419 |
| 54 |          |          |          |            |          |            |    2.429 |     1.9986 |   1.8467 |     2.4199 |
| 55 |          |          |          |            |          |            |    2.425 |     1.9842 |   1.8364 |     2.4227 |
| 56 |          |          |          |            |          |            |    2.421 |     1.9709 |   1.8278 |     2.4248 |
| 57 |          |          |          |            |          |            |    2.420 |     1.9599 |   1.8181 |     2.4265 |
| 58 |          |          |          |            |          |            |    2.417 |     1.9485 |   1.8096 |     2.4292 |
| 59 |          |          |          |            |          |            |    2.410 |     1.9367 |   1.8017 |     2.4284 |
| 60 |          |          |          |            |          |            |    2.408 |     1.9252 |   1.7951 |      2.436 |
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|

#+begin_src gnuplot :var data=Process-Pytorch-Portability :missing "?"  :file ../results/images/Process-Pytorch-Portability.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600 

  set title "Train and retraining loss for Pytorch"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 14"
  set key at graph 0.95, 1.0
  set key textcolor variable
  set xtics nomirror rotate by -45  font ", 12"

  set yrange [1.5:4]
  set ylabel "Loss" font ",14"
  set ytics nomirror rotate by -45 font ", 12"
  set style data lines
  plot  data u 1:2  with lp axis x1y1 lt 1 dashtype 1 lw 1  lc rgb '#ff0000' ps 1  pt 1 title '40% Training 1-20 Epochs' ,\
        data u 1:3  with lp axis x1y1 lt 1 dashtype 1 lw 1  lc rgb '#0000ff' ps 1  pt 1 title '60% Training 1-20 Epochs' ,\
        data u 1:4  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#ff0000' ps 1  pt 3 title '40% Resume   training 20-40 Epochs' ,\
        data u 1:5  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#ff8800' ps 2  pt 3 title '40% Ondevice training 20-40 Epochs' ,\
        data u 1:6  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#0000ff' ps 1  pt 3 title '60% Resuming training 20-40 Epochs' ,\
        data u 1:7  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#00ccff' ps 2  pt 3 title '60% Ondevice training 20-40 Epochs' ,\
        data u 1:8  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#ff0000' ps 1  pt 1 title '40% Resume   training 40-60 Epochs' ,\
        data u 1:9  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#ff8800' ps 2  pt 1 title '40% Ondevice training 40-60 Epochs' ,\
        data u 1:10 with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#0000ff' ps 1  pt 1 title '60% Resuming training 40-60 Epochs' ,\
        data u 1:11 with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#00ccff' ps 2  pt 1 title '60% Ondevice training 40-60 Epochs' 
#+end_src

#+RESULTS:
[[file:../results/images/Process-Pytorch-Portability.png]]

** Accuracy
#+tags: Vector size: 512
#+tags: Multihead 1
#+tags: Batch size 1
#+tags: Learning rate: 0.0000005
#+ATTR_LATEX: :font \scriptsize
#+tblname: Process-Pytorch-Acc
|----+-------------+-------+-------+-------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------|
| Nr | Pytorch Acc | Train | valid | tests | Re20train | Re20valid | Re20test | Re40train | Re40valid | Re40test | On20train | On20valid | On20test | On40train | On40valid | On40test |
|----+-------------+-------+-------+-------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------|
|  1 | Un40Q       | 0.843 | 0.165 | 0.154 |     0.925 |     0.185 |    0.188 |     0.937 |     0.197 |    0.204 |     0.880 |     0.193 |    0.208 |     0.931 |     0.192 |    0.208 |
|  2 | Un60Q       | 0.854 | 0.164 | 0.177 |     0.931 |     0.177 |    0.187 |     0.938 |     0.183 |    0.190 |     0.897 |     0.174 |    0.173 |     0.931 |     0.174 |    0.172 |
|----+-------------+-------+-------+-------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------|
|  3 | Sh40Q       | 0.840 | 0.163 | 0.174 |     0.926 |     0.183 |    0.202 |     0.937 |     0.192 |    0.210 |     0.880 |     0.184 |    0.195 |     0.930 |     0.198 |    0.197 |
|  4 | Sh60Q       | 0.853 | 0.177 | 0.177 |     0.931 |     0.186 |    0.201 |     0.938 |     0.198 |    0.196 |     0.892 |     0.174 |    0.172 |     0.933 |     0.172 |    0.175 |
|----+-------------+-------+-------+-------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------|
|  5 | Un40C       | 0.843 | 0.341 | 0.328 |     0.926 |     0.377 |    0.350 |     0.937 |     0.392 |    0.366 |     0.880 |     0.416 |    0.406 |     0.931 |     0.474 |    0.463 |
|  6 | Un60C       | 0.855 | 0.391 | 0.379 |     0.932 |     0.449 |    0.467 |     0.938 |     0.522 |    0.519 |     0.895 |     0.373 |    0.361 |     0.931 |     0.375 |    0.361 |
|----+-------------+-------+-------+-------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------|
|  7 | Sh40C       | 0.844 | 0.345 | 0.330 |     0.924 |     0.381 |    0.354 |     0.937 |     0.402 |    0.374 |     0.885 |     0.432 |    0.415 |     0.930 |     0.513 |    0.488 |
|  8 | Sh60C       | 0.855 | 0.395 | 0.389 |     0.931 |     0.478 |    0.490 |     0.938 |     0.548 |    0.560 |     0.891 |     0.380 |    0.392 |     0.933 |     0.374 |    0.391 |


#+begin_src gnuplot :var data=Process-Pytorch-Acc :missing "?"  :file ./thesis/results/images/Process-Pytorch-Acc-training.png :exports none
  reset
  set terminal pngcairo enhanced size 850,600 

  set title "Accuracy Performance for all training at different phases"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 14"
  set key at graph 0.60, 1.0
  set key textcolor variable
  set xlabel "Shuffle-Partation-Evaluation" font ",16" offset 1, -1
  set xtics nomirror rotate by -45  font ", 12"

  set yrange [0.8:1]
  set ylabel "Accuracy" font ",14"
  set ytics nomirror rotate by -45 font ", 12"
  set style data lines
  plot  data u 3:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#000000' ps 2  pt 1  title 'train for 20 epochs',\
        data u 6:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#0000ff' ps 2  pt 9  title 'Resume training for 20 epochs',\
        data u 9:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#0000ff' ps 2  pt 3  title 'Resume  training for 40 epochs',\
        data u 12:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#ff0000' ps 2  pt 9  title 'Ondevice training for 20 epochs',\
        data u 15:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#ff0000' ps 2  pt 3  title 'Ondevice training for 40 epochs'
#+end_src

#+RESULTS:
[[file:./thesis/results/images/Process-Pytorch-Acc-training.png]]



#+tblname: Process-Pytorch-tain-valid-test-Q
|----+-------------+-------+-------+-------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------|
| Nr | Pytorch Acc | Train | valid | tests | Re20valid | Re20test | Re40train | Re40valid | Re40test | On20train | On20valid | On20test | On40train | On40valid | On40test |
|----+-------------+-------+-------+-------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------|
|  1 | Un40        | 0.843 | 0.165 | 0.154 |     0.185 |    0.188 |     0.937 |     0.197 |    0.204 |     0.880 |     0.193 |    0.208 |     0.931 |     0.192 |    0.208 |
|  2 | Sh40        | 0.840 | 0.163 | 0.174 |     0.183 |    0.202 |     0.937 |     0.192 |    0.210 |     0.880 |     0.184 |    0.195 |     0.930 |     0.198 |    0.197 |
|----+-------------+-------+-------+-------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------|
|  3 | Un60        | 0.854 | 0.164 | 0.177 |     0.177 |    0.187 |     0.938 |     0.183 |    0.190 |     0.897 |     0.174 |    0.173 |     0.931 |     0.174 |    0.172 |
|  4 | Sh60        | 0.853 | 0.177 | 0.177 |     0.186 |    0.201 |     0.938 |     0.198 |    0.196 |     0.892 |     0.174 |    0.172 |     0.933 |     0.172 |    0.175 |

#+tblname: Process-Pytorch-tain-valid-test-C
|----+-------------+-------+-------+-------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------|
| Nr | Pytorch Acc | Train | valid | tests | Re20valid | Re20test | Re40train | Re40valid | Re40test | On20train | On20valid | On20test | On40train | On40valid | On40test |
|----+-------------+-------+-------+-------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------|
|  1 | Un40        | 0.843 | 0.341 | 0.328 |     0.377 |    0.350 |     0.937 |     0.392 |    0.366 |     0.880 |     0.416 |    0.406 |     0.931 |     0.474 |    0.463 |
|  2 | Sh40        | 0.844 | 0.345 | 0.330 |     0.381 |    0.354 |     0.937 |     0.402 |    0.374 |     0.885 |     0.432 |    0.415 |     0.930 |     0.513 |    0.488 |
|----+-------------+-------+-------+-------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------|
|  3 | Un60        | 0.855 | 0.391 | 0.379 |     0.449 |    0.467 |     0.938 |     0.522 |    0.519 |     0.895 |     0.373 |    0.361 |     0.931 |     0.375 |    0.361 |
|  4 | Sh60        | 0.855 | 0.395 | 0.389 |     0.478 |    0.490 |     0.938 |     0.548 |    0.560 |     0.891 |     0.380 |    0.392 |     0.933 |     0.374 |    0.391 |


#+begin_src gnuplot :var data=Process-Pytorch-tain-valid-test-C :missing "?"  :file ../results/images/Process-Pytorch-Acc-train-valid-test-C.png :exports none
  reset
  set terminal pngcairo enhanced size 1000,850 
  set title "Conversation performance for validation and test in different retraining case"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 16"
  set key at graph 0.48, 1
  set key textcolor variable

  set xtics nomirror rotate by -45  font ", 14"

  set yrange [0.3:0.65]
  set ylabel "Accuracy" font ",14"
  set ytics nomirror rotate by -45 font ", 14"
  set style data lines
  plot  data u 4:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#000000' ps 2  pt 3  title 'Validation set' ,\
        data u 5:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#000000' ps 2  pt 9  title 'Test set',\
        data u 6:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#ff0000' ps 2  pt 3  title 'Resume  20  Validation set',\
        data u 7:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#ff0000' ps 2  pt 9  title 'Resume  20  Test set',\
        data u 9:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 2 lw 4   lc rgb '#ff0000' ps 2  pt 3  title 'Resume  40  Validation set',\
        data u 10:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 4   lc rgb '#ff0000' ps 2  pt 9  title 'Resume  40  Test set',\
        data u 12:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#0000ff' ps 2  pt 3  title 'Ondevice 20  Validation set',\
        data u 13:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#0000ff' ps 2  pt 9  title 'Ondevice 20  Test set',\
        data u 15:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 4   lc rgb '#0000ff' ps 2  pt 3  title 'Ondevice 40  Validation set',\
        data u 16:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 4   lc rgb '#0000ff' ps 2  pt 9  title 'Ondevice 40  Test set'

#+end_src

#+begin_src gnuplot :var data=Process-Pytorch-tain-valid-test-C :missing "?"  :file ./thesis/results/images/Process-Pytorch-Acc-train-valid-test-C-RE.png :exports none
  reset
  set terminal pngcairo enhanced size 1000,850 
  set title "Conversation performance for resume training with 20 and 40 epochs"  font ", 17"
  set size ratio square
  set key box linestyle -2 font ", 18"
  set key at graph 0.60, 1
  set key textcolor variable
  set xlabel "Shuffle-Partation" font ",16" offset 1, -1
  set xtics nomirror rotate by -45  font ", 16"

  set yrange [0.3:0.65]
  set ylabel "Accuracy" font ",14"
  set ytics nomirror rotate by -45 font ", 15"
  set style data lines
  plot  data u 4:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 3 lw 2   lc rgb '#000000' ps 2  pt 3  title 'Validation set' ,\
        data u 5:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#000000' ps 2  pt 9  title 'Test set',\
        data u 6:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 2 lw 3   lc rgb '#dd9900' ps 2  pt 3  title 'Resume  20  Validation set',\
        data u 7:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 1 lw 3   lc rgb '#dd9900' ps 2  pt 9  title 'Resume  20  Test set',\
        data u 9:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 2 lw 4   lc rgb '#ff0000' ps 2  pt 3  title 'Resume  40  Validation set',\
        data u 10:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 4   lc rgb '#ff0000' ps 2  pt 9  title 'Resume  40  Test set'

#+end_src

#+RESULTS:
[[file:./thesis/results/images/Process-Pytorch-Acc-train-valid-test-C-RE.png]]

#+begin_src gnuplot :var data=Process-Pytorch-tain-valid-test-C :missing "?"  :file ./thesis/results/images/Process-Pytorch-Acc-train-valid-test-C-ON.png :exports none
  reset
  set terminal pngcairo enhanced size 1000,850 
  set title "Conversation performance for on-device training with 20 and 40 epochs"  font ", 17"
  set size ratio square
  set key box linestyle -2 font ", 18"
  set key at graph 0.60, 1
  set key textcolor variable
  set xlabel "Shuffle-Partation" font ",16" offset 1, -1
  set xtics nomirror rotate by -45  font ", 16"

  set yrange [0.3:0.65]
  set ylabel "Accuracy" font ",18"
  set ytics nomirror rotate by -45 font ", 15"
  set style data lines
  plot  data u 4:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 3 lw 2   lc rgb '#000000' ps 2  pt 3  title 'Validation set' ,\
        data u 5:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#000000' ps 2  pt 9  title 'Test set',\
        data u 12:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#0099dd' ps 2  pt 3  title 'Ondevice 20  Validation set',\
        data u 13:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#0099dd' ps 2  pt 9  title 'Ondevice 20  Test set',\
        data u 15:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 4   lc rgb '#0000ff' ps 2  pt 3  title 'Ondevice 40  Validation set',\
        data u 16:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 4   lc rgb '#0000ff' ps 2  pt 9  title 'Ondevice 40  Test set'

#+end_src

#+RESULTS:
[[file:./thesis/results/images/Process-Pytorch-Acc-train-valid-test-C-ON.png]]

#+begin_src gnuplot :var data=Process-Pytorch-tain-valid-test-Q :missing "?"  :file ./thesis/results/images/Process-Pytorch-Acc-train-valid-test-Q.png :exports none
  reset
  set terminal pngcairo enhanced size 1000,800 
  set title "Question evaluation performance at different phases"  font ", 16"
  set size ratio square
  set key box linestyle -2 font ", 16"
  set key at graph 0.95, 1
  set key textcolor variable
  set xlabel "Shuffle-Partation-Evaluation" font ",16" offset 1, -1
  set xtics nomirror rotate by -45  font ", 14"

  set yrange [0.14:0.235]
  set ylabel "Accuracy" font ",14"
  set ytics nomirror rotate by -45 font ", 14"
  set style data lines
  plot  data u 4:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#000000' ps 2  pt 3  title 'Validation set' ,\
        data u 5:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#000000' ps 2  pt 9  title 'Test set',\
        data u 6:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#ff0000' ps 2  pt 3  title 'Resume  20  Validation set',\
        data u 7:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#ff0000' ps 2  pt 9  title 'Resume  20  Test set',\
        data u 9:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 2 lw 4   lc rgb '#ff0000' ps 2  pt 3  title 'Resume  40  Validation set',\
        data u 10:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 4   lc rgb '#ff0000' ps 2  pt 9  title 'Resume  40  Test set',\
        data u 12:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#0000ff' ps 2  pt 3  title 'Ondevice 20  Validation set',\
        data u 13:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#0000ff' ps 2  pt 9  title 'Ondevice 20  Test set',\
        data u 15:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 4   lc rgb '#0000ff' ps 1  pt 3  title 'Ondevice 40  Validation set',\
        data u 16:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 4   lc rgb '#0000ff' ps 1  pt 9  title 'Ondevice 40  Test set'
  #+end_src

  #+RESULTS:
  [[file:./thesis/results/images/Process-Pytorch-Acc-train-valid-test-Q.png]]

#+begin_src gnuplot :var data=Process-Pytorch-tain-valid-test-Q :missing "?"  :file ./thesis/results/images/Process-Pytorch-Acc-train-valid-test-Q-ON.png :exports none
  reset
  set terminal pngcairo enhanced size 1000,800 
  set title "Question evaluation performance for on-device training with 20 and 40 epochs"  font ", 17"
  set size ratio square
  set key box linestyle -2 font ", 18"
  set key at graph 0.95, 1
  set key textcolor variable
  set xlabel "Shuffle-Partation" font ",16" offset 1, -1
  set xtics nomirror rotate by -45  font ", 16"

  set yrange [0.14:0.235]
  set ylabel "Accuracy" font ",18"
  set ytics nomirror rotate by -45 font ", 15"
  set style data lines
  plot  data u 4:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 3 lw 2   lc rgb '#000000' ps 2  pt 3  title 'Validation set' ,\
        data u 5:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#000000' ps 2  pt 9  title 'Test set',\
        data u 12:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 3   lc rgb '#0099dd' ps 2  pt 3  title 'Ondevice 20  Validation set',\
        data u 13:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 3   lc rgb '#0099dd' ps 2  pt 9  title 'Ondevice 20  Test set',\
        data u 15:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 4   lc rgb '#0000ff' ps 1  pt 3  title 'Ondevice 40  Validation set',\
        data u 16:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 4   lc rgb '#0000ff' ps 1  pt 9  title 'Ondevice 40  Test set'
  #+end_src

  #+RESULTS:
  [[file:./thesis/results/images/Process-Pytorch-Acc-train-valid-test-Q-ON.png]]

#+begin_src gnuplot :var data=Process-Pytorch-tain-valid-test-Q :missing "?"  :file ./thesis/results/images/Process-Pytorch-Acc-train-valid-test-Q-RE.png :exports none
  reset
  set terminal pngcairo enhanced size 1000,800 
  set title "Question evaluation performance for resume training with 20 and 40 epochs"  font ", 17"
  set size ratio square
  set key box linestyle -2 font ", 18"
  set key at graph 0.95, 1
  set key textcolor variable
  set xlabel "Shuffle-Partation" font ",16" offset 1, -1
  set xtics nomirror rotate by -45  font ", 16"

  set yrange [0.14:0.235]
  set ylabel "Accuracy" font ",18"
  set ytics nomirror rotate by -45 font ", 15"
  set style data lines
  plot  data u 4:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 3 lw 2   lc rgb '#000000' ps 2  pt 3  title 'Validation set' ,\
        data u 5:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#000000' ps 2  pt 9  title 'Test set',\
        data u 6:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 2 lw 3   lc rgb '#dd9900' ps 2  pt 3  title 'Resume  20  Validation set',\
        data u 7:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 1 lw 3   lc rgb '#dd9900' ps 2  pt 9  title 'Resume  20  Test set',\
        data u 9:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 2 lw 4   lc rgb '#ff0000' ps 2  pt 3  title 'Resume  40  Validation set',\
        data u 10:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 4   lc rgb '#ff0000' ps 2  pt 9  title 'Resume  40  Test set'
  #+end_src

  #+RESULTS:
  [[file:./thesis/results/images/Process-Pytorch-Acc-train-valid-test-Q-RE.png]]


** Loss
#+ATTR_LATEX: :font \scriptsize
#+tblname: Process-Pytorch-Loss
|----+--------------+-------+-------+-------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------|
| Nr | Pytorch Loss | Train | Valid |  test | Re20train | Re20valid | Re20test | Re40train | Re40valid | Re40test | On20train | On20valid | On20test | On40train | On40valid | On40test |
|----+--------------+-------+-------+-------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------|
|  1 | Un40Q        | 0.808 | 3.590 | 3.588 |     0.392 |     3.467 |    3.471 |     0.283 |     3.452 |    3.460 |     0.608 |     3.430 |    3.429 |     0.321 |     3.607 |    3.589 |
|  2 | Sh40Q        | 0.807 | 3.526 | 3.538 |     0.392 |     3.447 |    3.466 |     0.284 |     3.453 |    3.481 |     0.606 |     3.439 |    3.465 |     0.321 |     3.600 |    3.637 |
|  3 | Un60Q        | 0.734 | 3.535 | 3.502 |     0.334 |     3.613 |    3.553 |     0.238 |     3.708 |    3.710 |     0.583 |     3.581 |    3.560 |     0.343 |     3.581 |    3.734 |
|  4 | Sh60Q        | 0.737 | 3.559 | 3.548 |     0.338 |     3.559 |    3.560 |     0.242 |     3.672 |    3.732 |     0.587 |     3.626 |    3.615 |     0.346 |     3.817 |    3.740 |
|----+--------------+-------+-------+-------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------|
|  5 | Un40C        | 0.808 | 2.646 | 2.719 |     0.329 |     2.529 |    2.621 |     0.283 |     2.469 |    2.568 |     0.608 |     2.259 |    2.349 |     0.321 |     2.055 |    2.142 |
|  6 | Sh40C        | 0.805 | 2.613 | 2.700 |     0.388 |     2.479 |    2.588 |     0.279 |     2.408 |    2.521 |     0.588 |     2.196 |    2.289 |     0.306 |     1.925 |    2.019 |
|  7 | Un60C        | 0.738 | 2.426 | 2.419 |     0.336 |     2.156 |    2.139 |     0.241 |     1.896 |    1.883 |     0.581 |     2.436 |    2.425 |     0.347 |     2.478 |    2.465 |
|  8 | Sh60C        | 0.727 | 2.390 | 2.378 |     0.324 |     2.072 |    2.048 |     0.234 |     1.795 |    1.775 |     0.568 |     2.393 |    2.378 |     0.338 |     2.436 |    2.420 |
|----+--------------+-------+-------+-------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------|


#+begin_src gnuplot :var data=Process-Pytorch-Loss :missing "?"  :file ../results/images/Process-Pytorch-Loss-training.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600 

  set title "Loss Performance for Training, resuming training and ondevice training with Pytorch"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 12"
  set key at graph 0.37, 1.0
  set key textcolor variable

  set xtics nomirror rotate by -45  font ", 12"

  set yrange [0:1]
  set ylabel "Loss" font ",14"
  set ytics nomirror rotate by -45 font ", 12"
  set style data lines
  plot  data u 3:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#000000' ps 2  pt 1  title 'train',\
        data u 6:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#0000ff' ps 2  pt 9  title 'trainRe20',\
        data u 9:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#0000ff' ps 2  pt 3  title 'trainRe40',\
        data u 12:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#ff0000' ps 2  pt 9  title 'trainOn20',\
        data u 15:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#ff0000' ps 2  pt 3  title 'trainOn40'
#+end_src

#+ATTR_LATEX:  :scale 0.35
file:../results/images/Process-Pytorch-Loss-training.png


#+begin_src gnuplot :var data=Process-Pytorch-Loss :missing "?"  :file ../results/images/Process-Pytorch-Loss-train-valid-test.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600 

  set title "Loss performance of training, validation and test with pytorch"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 12"
  set key at graph 0.37, 1.0
  set key textcolor variable

  set xtics nomirror rotate by -45  font ", 12"

  set yrange [0:4]
  set ylabel "Loss" font ",14"
  set ytics nomirror rotate by -45 font ", 12"
  set style data lines
  plot  data u 3:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#000000' ps 2  pt 9  title 'train',\
        data u 4:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#0000ff' ps 2  pt 9  title 'valid',\
        data u 5:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#ff0000' ps 2  pt 9  title 'test'

#+end_src

#+ATTR_LATEX:  :scale 0.35
[[file:../results/images/Process-Pytorch-Loss-train-valid-test.png]]

#+ATTR_LATEX: :font \scriptsize
#+tblname: Process-Pytorch-Loss-Q
|----+--------------+-------+-------+-------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------|
| Nr | Pytorch Loss | Train | Valid |  test | Re20train | Re20valid | Re20test | Re40train | Re40valid | Re40test | On20train | On20valid | On20test | On40train | On40valid | On40test |
|----+--------------+-------+-------+-------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------|
|  1 | Un40Q        | 0.808 | 3.590 | 3.588 |     0.392 |     3.467 |    3.471 |     0.283 |     3.452 |    3.460 |     0.608 |     3.430 |    3.429 |     0.321 |     3.607 |    3.589 |
|  2 | Sh40Q        | 0.807 | 3.526 | 3.538 |     0.392 |     3.447 |    3.466 |     0.284 |     3.453 |    3.481 |     0.606 |     3.439 |    3.465 |     0.321 |     3.600 |    3.637 |
|  3 | Un60Q        | 0.734 | 3.535 | 3.502 |     0.334 |     3.613 |    3.553 |     0.238 |     3.708 |    3.710 |     0.583 |     3.581 |    3.560 |     0.343 |     3.581 |    3.734 |
|  4 | Sh60Q        | 0.737 | 3.559 | 3.548 |     0.338 |     3.559 |    3.560 |     0.242 |     3.672 |    3.732 |     0.587 |     3.626 |    3.615 |     0.346 |     3.817 |    3.740 |
|----+--------------+-------+-------+-------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------|


#+begin_src gnuplot :var data=Process-Pytorch-Loss-Q :missing "?"  :file ../results/images/Process-Pytorch-Loss-valid-Q.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600 

  set title "Loss of Validation for training, resume training and ondevice training of question"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 12"
  set key at graph 0.37, 1.0
  set key textcolor variable

  set xtics nomirror rotate by -45  font ", 12"

  set yrange [3.3:4]
  set ylabel "Loss" font ",14"
  set ytics nomirror rotate by -45 font ", 12"
  set style data lines
  plot  data u 4:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#000000' ps 2  pt 1  title 'Valid',\
        data u 7:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#0000ff' ps 2  pt 9  title 'ValidRe20',\
        data u 10:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#0000ff' ps 2  pt 3  title 'ValidRe40',\
        data u 13:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#ff0000' ps 2  pt 9  title 'ValidOn20',\
        data u 16:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#ff0000' ps 2  pt 3  title 'ValidOn40'
#+end_src

#+ATTR_LATEX:  :scale 0.35
[[file:../results/images/Process-Pytorch-Loss-valid-Q.png]]


#+begin_src gnuplot :var data=Process-Pytorch-Loss-Q :missing "?"  :file ../results/images/Process-Pytorch-Loss-test-Q.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600 

  set title "Loss of Test for training, resume training and ondevice training of question"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 12"
  set key at graph 0.37, 1.0
  set key textcolor variable

  set xtics nomirror rotate by -45  font ", 12"

  set yrange [3.3:4]
  set ylabel "Loss" font ",14"
  set ytics nomirror rotate by -45 font ", 12"
  set style data lines
  plot  data u 5:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#000000' ps 2  pt 1  title 'test',\
        data u 8:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#0000ff' ps 2  pt 9  title 'testRe20',\
        data u 11:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#0000ff' ps 2  pt 3  title 'testRe40',\
        data u 14:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#ff0000' ps 2  pt 9  title 'testOn20',\
        data u 17:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#ff0000' ps 2  pt 3  title 'testOn40'
#+end_src

#+ATTR_LATEX:  :scale 0.35
[[file:../results/images/Process-Pytorch-Loss-test-Q.png]]


#+ATTR_LATEX: :font \scriptsize
#+tblname: Process-Pytorch-Loss-C
|----+--------------+-------+-------+-------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------|
| Nr | Pytorch Loss | Train | Valid |  test | Re20train | Re20valid | Re20test | Re40train | Re40valid | Re40test | On20train | On20valid | On20test | On40train | On40valid | On40test |
|----+--------------+-------+-------+-------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------|
|  1 | Un40C        | 0.808 | 2.646 | 2.719 |     0.329 |     2.529 |    2.621 |     0.283 |     2.469 |    2.568 |     0.608 |     2.259 |    2.349 |     0.321 |     2.055 |    2.142 |
|  2 | Sh40C        | 0.805 | 2.613 | 2.700 |     0.388 |     2.479 |    2.588 |     0.279 |     2.408 |    2.521 |     0.588 |     2.196 |    2.289 |     0.306 |     1.925 |    2.019 |
|  3 | Un60C        | 0.738 | 2.426 | 2.419 |     0.336 |     2.156 |    2.139 |     0.241 |     1.896 |    1.883 |     0.581 |     2.436 |    2.425 |     0.347 |     2.478 |    2.465 |
|  4 | Sh60C        | 0.727 | 2.390 | 2.378 |     0.324 |     2.072 |    2.048 |     0.234 |     1.795 |    1.775 |     0.568 |     2.393 |    2.378 |     0.338 |     2.436 |    2.420 |
|----+--------------+-------+-------+-------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------+-----------+-----------+----------|

#+begin_src gnuplot :var data=Process-Pytorch-Loss-C :missing "?"  :file ../results/images/Process-Pytorch-Loss-valid-C.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600 

  set title "Loss of validation for training, resume training and ondevice training of conversation"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 12"
  set key at graph 0.37, 1.0
  set key textcolor variable

  set xtics nomirror rotate by -45  font ", 12"

  set yrange [1.5:3]
  set ylabel "Loss" font ",14"
  set ytics nomirror rotate by -45 font ", 12"
  set style data lines
  plot  data u 4:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#000000' ps 2  pt 1  title 'Valid',\
        data u 7:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#0000ff' ps 2  pt 9  title 'ValidRe20',\
        data u 10:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#0000ff' ps 2  pt 3  title 'ValidRe40',\
        data u 13:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#ff0000' ps 2  pt 9  title 'ValidOn20',\
        data u 16:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#ff0000' ps 2  pt 3  title 'ValidOn40'
#+end_src

#+ATTR_LATEX:  :scale 0.35
[[file:../results/images/Process-Pytorch-Loss-valid-C.png]]


#+begin_src gnuplot :var data=Process-Pytorch-Loss-C :missing "?"  :file ../results/images/Process-Pytorch-Loss-test-C.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600 

  set title "Loss of test for training, resume training and ondevice training of conversation"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 12"
  set key at graph 0.37, 1.0
  set key textcolor variable

  set xtics nomirror rotate by -45  font ", 12"

  set yrange [1.5:3]
  set ylabel "Loss" font ",14"
  set ytics nomirror rotate by -45 font ", 12"
  set style data lines
  plot  data u 5:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#000000' ps 2  pt 1  title 'test',\
        data u 8:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#0000ff' ps 2  pt 9  title 'testRe20',\
        data u 11:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#0000ff' ps 2  pt 3  title 'testRe40',\
        data u 14:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#ff0000' ps 2  pt 9  title 'testOn20',\
        data u 17:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#ff0000' ps 2  pt 3  title 'testOn40'
#+end_src

#+ATTR_LATEX:  :scale 0.35
[[file:../results/images/Process-Pytorch-Loss-test-C.png]]

* ORT Training
ONNX runtime for Training can accelarate our training process, but it failed to export ONNX. Here we only study the performance for model training.
#+begin_export latex
\begin{minted}[escapeinside=||,mathescape=true]{text}
|$\textbf{\textit{ORT training}}$|(ondevice_data, ondevice_label, valid_data, valid_label):
    device |$\gets$| gpu
        model.initialise()
        for epoch n = 0, 1,...20 do:
            accuracy |$\gets$| model(train_data, train_label)
                |$w_{n+1} \gets Update(w_{n})$|
            Accuracy.apend(accuracy)
        Acc |$\Leftarrow$| max(Accuracy)
        Time |$\Leftarrow$| time comsumption
\end{minted}
#+end_export

#+ATTR_LATEX: :font \scriptsize
#+tblname: Pytorch-training-performace
|--------+----------+-------+-------+------------|
| epochs | process  | ORT_T | ORT_A | evaluation |
|--------+----------+-------+-------+------------|
|     10 | training |   656 | 0.167 | valid      |
|--------+----------+-------+-------+------------|
|     20 | training |       |       |            |

* ORT Retraining
** Workflow
#+BEGIN_CENTER
#+ATTR_LaTeX: :height 0.40\textwidth :center
[[../results/process/Process_ONNX.drawio.png]]
#+END_CENTER

#+BEGIN_CENTER
#+ATTR_LaTeX: :height 0.70\textwidth :center
[[../results/images/Model_onnx.drawio.png]]
#+END_CENTER
** Algo
*** ONNX training
#+begin_export latex
\begin{minted}[escapeinside=||,mathescape=true]{text}
|vector size: $V$ =  512|
|multihead: $M$ = 1|
|layers: $L$ = 4|
|learning rate: $R$ = 0.0000005|
|batchsize: $B$ = 1|
|evaluation: question|
|train set persentage: 60|
|device: [cpu, gpu]|
|$\textbf{\textit{training}}$|(train_data, train_label, valid_data, valid_label):
    for device in [cpu, gpu] do:
        model.initialise()
        for epoch n = 1, 2,...10 do:
            model.train(train_data, train_label)
                |$w_{n+1} \gets Update(w_{n})$|
            accuracy |$\gets$| model(valid_data, valid_label)
            Accuracy.append(accuracy)
        Acc |$\Leftarrow$| max (Accuracy)
        Time |$\Leftarrow$| time comsumption
        model_state |$\Leftarrow$| model
        model_whole |$\Leftarrow$| model
        check_points |$\Leftarrow$| model
\end{minted}
#+end_export
*** ONNX Resuming training
#+begin_export latex
\begin{minted}[escapeinside=||,mathescape=true]{text}
|$\textbf{\textit{Pytorch resume training}}$|(train_data, train_label, valid_data, valid_label):
    model.initialise()
    model_parameter |$\gets$| check_points
    model.load(model_parameter)
    accuracy_before_resuming_training |$\gets$| model(valid_data, valid_label)
    Time |$\Leftarrow$| time comsumption
    for epoch n = 21, 11,...40 do:
        accuracy |$\gets$| model(train_data, train_label)
            |$w_{n+1} \gets Update(w_{n})$|
        Accuracy.apend(accuracy)
    Acc |$\Leftarrow$| max(Accuracy)
    Time |$\Leftarrow$| time comsumption
    model_state_resuming |$\Leftarrow$| model
    model_whole_resuming |$\Leftarrow$| model
    check_points_resuming |$\Leftarrow$| model
\end{minted}
#+end_export
*** ONNX Ondevice training
#+begin_export latex
\begin{minted}[escapeinside=||,mathescape=true]{text}
|$\textbf{\textit{ondevice training}}$|(ondevice_data, ondevice_label, valid_data, valid_label):
    model.initialise()
    model_parameter |$\gets$| check_points
    model.load(model_parameter)
    accuracy_before_resuming_training |$\gets$| model(valid_data, valid_label)
    Time |$\Leftarrow$| time comsumption
    for epoch n = 21, 11,...40 do:
        accuracy |$\gets$| model(train_data, train_label)
            |$w_{n+1} \gets Update(w_{n})$|
        Accuracy.apend(accuracy)
    Acc |$\Leftarrow$| max(Accuracy)
    Time |$\Leftarrow$| time comsumption
    model_state_ondevice |$\Leftarrow$| model
    model_whole_ondevice |$\Leftarrow$| model
    check_points_ondevice |$\Leftarrow$| model
\end{minted}
#+end_export
*** ONNX testing
#+begin_export latex
\begin{minted}[escapeinside=||,mathescape=true]{text}
|$\textbf{\textit{pytroch testing}}$|(test_data, test_label):
    model.initialise()
    for model_parameter in [model_state, model_whole, check_points] do:
        model.load(model_parameter)
        accuracy |$\Leftarrow$| model(test_data, test_label)
        Time |$\Leftarrow$| time comsumption
\end{minted}
#+end_export
** Python
*** Portability 5e-7
#+tblname: Process-ONNX-python-Portability
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|
|  0 | resume40 | resume60 | resume40 | ondevice40 | resume60 | ondevice60 | resume40 | ondevice40 | resume60 | ondevice60 |
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|
|  1 |   3.5328 |   3.4151 |          |            |          |            |          |            |          |            |
|  2 |   3.3647 |   3.2222 |          |            |          |            |          |            |          |            |
|  3 |   3.2477 |   3.0831 |          |            |          |            |          |            |          |            |
|  4 |   3.1476 |   2.9745 |          |            |          |            |          |            |          |            |
|  5 |   3.0698 |    2.886 |          |            |          |            |          |            |          |            |
|  6 |   2.9999 |   2.8116 |          |            |          |            |          |            |          |            |
|  7 |   2.9424 |   2.7564 |          |            |          |            |          |            |          |            |
|  8 |   2.8879 |   2.7022 |          |            |          |            |          |            |          |            |
|  9 |   2.8472 |   2.6616 |          |            |          |            |          |            |          |            |
| 10 |   2.8106 |   2.6215 |          |            |          |            |          |            |          |            |
| 11 |   2.7817 |   2.5882 |          |            |          |            |          |            |          |            |
| 12 |   2.7524 |   2.5601 |          |            |          |            |          |            |          |            |
| 13 |   2.7279 |   2.5314 |          |            |          |            |          |            |          |            |
| 14 |   2.7061 |    2.504 |          |            |          |            |          |            |          |            |
| 15 |   2.6898 |   2.4856 |          |            |          |            |          |            |          |            |
| 16 |    2.672 |   2.4596 |          |            |          |            |          |            |          |            |
| 17 |   2.6537 |   2.4428 |          |            |          |            |          |            |          |            |
| 18 |   2.6401 |   2.4241 |          |            |          |            |          |            |          |            |
| 19 |    2.627 |   2.4028 |          |            |          |            |          |            |          |            |
| 20 |   2.6137 |   2.3902 |          |            |          |            |          |            |          |            |
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|
| 21 |          |          |    2.484 |      2.398 |    2.106 |      2.376 |          |            |          |            |
| 22 |          |          |    2.224 |      1.909 |    1.778 |      2.342 |          |            |          |            |
| 23 |          |          |    1.955 |      1.545 |    1.632 |      2.288 |          |            |          |            |
| 24 |          |          |    1.808 |      1.350 |    1.548 |      2.203 |          |            |          |            |
| 25 |          |          |    1.718 |      1.255 |    1.492 |      2.099 |          |            |          |            |
| 26 |          |          |    1.658 |      1.206 |    1.453 |      2.008 |          |            |          |            |
| 27 |          |          |    1.617 |      1.179 |    1.424 |      1.940 |          |            |          |            |
| 28 |          |          |    1.587 |      1.164 |    1.402 |      1.889 |          |            |          |            |
| 29 |          |          |    1.565 |      1.156 |    1.385 |      1.852 |          |            |          |            |
| 30 |          |          |    1.549 |      1.153 |    1.372 |      1.826 |          |            |          |            |
| 31 |          |          |    1.538 |      1.153 |    1.361 |      1.807 |          |            |          |            |
| 32 |          |          |    1.529 |      1.154 |    1.352 |      1.794 |          |            |          |            |
| 33 |          |          |    1.523 |      1.157 |    1.346 |      1.786 |          |            |          |            |
| 34 |          |          |     1.52 |      1.161 |    1.340 |      1.782 |          |            |          |            |
| 35 |          |          |    1.518 |      1.166 |    1.337 |      1.780 |          |            |          |            |
| 36 |          |          |    1.518 |      1.173 |    1.334 |      1.780 |          |            |          |            |
| 37 |          |          |    1.519 |      1.180 |    1.333 |      1.783 |          |            |          |            |
| 38 |          |          |    1.522 |      1.187 |    1.333 |      1.786 |          |            |          |            |
| 39 |          |          |    1.526 |      1.196 |    1.333 |      1.791 |          |            |          |            |
| 40 |          |          |    1.530 |      1.204 |    1.335 |      1.796 |          |            |          |            |
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|
| 41 |          |          |          |            |          |            |    1.534 |      1.213 |    1.338 |      1.803 |
| 42 |          |          |          |            |          |            |    1.540 |      1.222 |    1.341 |      1.810 |
| 43 |          |          |          |            |          |            |    1.546 |      1.231 |    1.345 |      1.818 |
| 44 |          |          |          |            |          |            |    1.553 |      1.240 |    1.350 |      1.827 |
| 45 |          |          |          |            |          |            |    1.560 |      1.249 |    1.355 |      1.836 |
| 46 |          |          |          |            |          |            |    1.567 |      1.258 |    1.361 |      1.845 |
| 47 |          |          |          |            |          |            |    1.573 |      1.267 |    1.367 |      1.856 |
| 48 |          |          |          |            |          |            |    1.581 |      1.277 |    1.373 |      1.866 |
| 49 |          |          |          |            |          |            |    1.588 |      1.286 |    1.379 |      1.877 |
| 50 |          |          |          |            |          |            |    1.595 |      1.296 |    1.384 |      1.887 |
| 51 |          |          |          |            |          |            |    1.602 |      1.305 |    1.390 |      1.898 |
| 52 |          |          |          |            |          |            |    1.609 |      1.315 |    1.396 |      1.909 |
| 53 |          |          |          |            |          |            |    1.616 |      1.324 |    1.403 |      1.920 |
| 54 |          |          |          |            |          |            |    1.623 |      1.333 |    1.410 |      1.931 |
| 55 |          |          |          |            |          |            |    1.631 |      1.342 |    1.418 |      1.942 |
| 56 |          |          |          |            |          |            |    1.638 |      1.351 |    1.425 |      1.953 |
| 57 |          |          |          |            |          |            |    1.645 |      1.360 |    1.432 |      1.964 |
| 58 |          |          |          |            |          |            |    1.652 |      1.369 |    1.440 |      1.974 |
| 59 |          |          |          |            |          |            |    1.658 |      1.377 |    1.448 |      1.984 |
| 60 |          |          |          |            |          |            |    1.664 |      1.385 |    1.456 |      1.994 |
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|


#+begin_src gnuplot :var data=Process-ONNX-python-Portability :missing "?"  :file ../results/images/Process-ONNX-python-Portability-5e-7.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600 

  set title "Train and retraining loss for ONNX with python with learning rate 5e-7"  font ", 16"
  set size ratio square
  set key box linestyle -2 font ", 14"
  set key at graph 1.0, 1.0
  set key textcolor variable
  set xtics nomirror rotate by -45  font ", 12"

  set yrange [1:4]
  set ylabel "Loss" font ",14"
  set ytics nomirror rotate by -45 font ", 12"
  set style data lines
  plot  data u 1:2  with lp axis x1y1 lt 1 dashtype 1 lw 1  lc rgb '#ff0000' ps 1  pt 1 title '40% Training 1-20 Epochs' ,\
        data u 1:3  with lp axis x1y1 lt 1 dashtype 1 lw 1  lc rgb '#0000ff' ps 1  pt 1 title '60% Training 1-20 Epochs' ,\
        data u 1:4  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#ff0000' ps 1  pt 3 title '40% Resume   training 20-40 Epochs' ,\
        data u 1:5  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#ff8800' ps 2  pt 3 title '40% Ondevice training 20-40 Epochs' ,\
        data u 1:6  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#0000ff' ps 1  pt 3 title '60% Resuming training 20-40 Epochs' ,\
        data u 1:7  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#0077ff' ps 2  pt 3 title '60% Ondevice training 20-40 Epochs' ,\
        data u 1:8  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#ff0000' ps 1  pt 1 title '40% Resume   training 40-60 Epochs' ,\
        data u 1:9  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#ff8800' ps 2  pt 1 title '40% Ondevice training 40-60 Epochs' ,\
        data u 1:10 with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#0000ff' ps 1  pt 1 title '60% Resuming training 40-60 Epochs' ,\
        data u 1:11 with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#0077ff' ps 2  pt 1 title '60% Ondevice training 40-60 Epochs' 
#+end_src

#+RESULTS:
[[file:../results/images/Process-ONNX-python-Portability-5e-7.png]]

*** Portability 1e-7
#+tblname: Process-ONNX-python-Portability-new-Learning-rate
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|
|  0 | resume40 | resume60 | resume40 | ondevice40 | resume60 | ondevice60 | resume40 | ondevice40 | resume60 | ondevice60 |
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|
|  1 |   3.5328 |   3.4151 |          |            |          |            |          |            |          |            |
|  2 |   3.3647 |   3.2222 |          |            |          |            |          |            |          |            |
|  3 |   3.2477 |   3.0831 |          |            |          |            |          |            |          |            |
|  4 |   3.1476 |   2.9745 |          |            |          |            |          |            |          |            |
|  5 |   3.0698 |    2.886 |          |            |          |            |          |            |          |            |
|  6 |   2.9999 |   2.8116 |          |            |          |            |          |            |          |            |
|  7 |   2.9424 |   2.7564 |          |            |          |            |          |            |          |            |
|  8 |   2.8879 |   2.7022 |          |            |          |            |          |            |          |            |
|  9 |   2.8472 |   2.6616 |          |            |          |            |          |            |          |            |
| 10 |   2.8106 |   2.6215 |          |            |          |            |          |            |          |            |
| 11 |   2.7817 |   2.5882 |          |            |          |            |          |            |          |            |
| 12 |   2.7524 |   2.5601 |          |            |          |            |          |            |          |            |
| 13 |   2.7279 |   2.5314 |          |            |          |            |          |            |          |            |
| 14 |   2.7061 |    2.504 |          |            |          |            |          |            |          |            |
| 15 |   2.6898 |   2.4856 |          |            |          |            |          |            |          |            |
| 16 |    2.672 |   2.4596 |          |            |          |            |          |            |          |            |
| 17 |   2.6537 |   2.4428 |          |            |          |            |          |            |          |            |
| 18 |   2.6401 |   2.4241 |          |            |          |            |          |            |          |            |
| 19 |    2.627 |   2.4028 |          |            |          |            |          |            |          |            |
| 20 |   2.6137 |   2.3902 |          |            |          |            |          |            |          |            |
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|
| 21 |          |          |    2.610 |      2.588 |    2.370 |      2.390 |          |            |          |            |
| 22 |          |          |    2.585 |      2.544 |    2.331 |      2.389 |          |            |          |            |
| 23 |          |          |    2.560 |      2.503 |    2.286 |      2.390 |          |            |          |            |
| 24 |          |          |    2.534 |      2.459 |    2.229 |      2.391 |          |            |          |            |
| 25 |          |          |    2.507 |      2.412 |    2.159 |      2.392 |          |            |          |            |
| 26 |          |          |    2.477 |      2.357 |    2.078 |      2.392 |          |            |          |            |
| 27 |          |          |    2.445 |      2.291 |    1.994 |      2.391 |          |            |          |            |
| 28 |          |          |    2.408 |      2.209 |    1.917 |      2.389 |          |            |          |            |
| 29 |          |          |    2.367 |      2.113 |    1.850 |      2.387 |          |            |          |            |
| 30 |          |          |    2.320 |      2.009 |    1.795 |      2.385 |          |            |          |            |
| 31 |          |          |    2.268 |      1.907 |    1.749 |      2.381 |          |            |          |            |
| 32 |          |          |    2.213 |      1.815 |    1.710 |      2.377 |          |            |          |            |
| 33 |          |          |    2.156 |      1.734 |    1.676 |      2.373 |          |            |          |            |
| 34 |          |          |    2.100 |      1.664 |    1.646 |      2.367 |          |            |          |            |
| 35 |          |          |    2.046 |      1.601 |    1.620 |      2.360 |          |            |          |            |
| 36 |          |          |    1.996 |      1.546 |    1.598 |      2.353 |          |            |          |            |
| 37 |          |          |    1.952 |      1.497 |    1.577 |      2.344 |          |            |          |            |
| 38 |          |          |    1.912 |      1.454 |    1.559 |      2.334 |          |            |          |            |
| 39 |          |          |    1.877 |      1.417 |    1.543 |      2.323 |          |            |          |            |
| 40 |          |          |    1.846 |      1.384 |    1.528 |      2.311 |          |            |          |            |
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|
| 41 |          |          |          |            |          |            |    1.818 |      1.356 |    1.515 |      2.297 |
| 42 |          |          |          |            |          |            |    1.794 |      1.332 |    1.503 |      2.283 |
| 43 |          |          |          |            |          |            |    1.771 |      1.312 |    1.492 |      2.267 |
| 44 |          |          |          |            |          |            |    1.751 |      1.293 |    1.482 |      2.251 |
| 45 |          |          |          |            |          |            |    1.732 |      1.278 |    1.472 |      2.233 |
| 46 |          |          |          |            |          |            |    1.715 |      1.264 |    1.463 |      2.215 |
| 47 |          |          |          |            |          |            |    1.700 |      1.252 |    1.455 |      2.196 |
| 48 |          |          |          |            |          |            |    1.685 |      1.242 |    1.448 |      2.178 |
| 49 |          |          |          |            |          |            |    1.672 |      1.233 |    1.441 |      2.159 |
| 50 |          |          |          |            |          |            |    1.660 |      1.224 |    1.434 |      2.139 |
| 51 |          |          |          |            |          |            |    1.649 |      1.217 |    1.428 |      2.121 |
| 52 |          |          |          |            |          |            |    1.638 |      1.211 |    1.422 |      2.102 |
| 53 |          |          |          |            |          |            |    1.628 |      1.205 |    1.416 |      2.084 |
| 54 |          |          |          |            |          |            |    1.619 |      1.200 |    1.411 |      2.067 |
| 55 |          |          |          |            |          |            |    1.611 |      1.196 |    1.406 |      2.050 |
| 56 |          |          |          |            |          |            |    1.603 |      1.192 |    1.401 |      2.034 |
| 57 |          |          |          |            |          |            |    1.595 |      1.189 |    1.397 |      2.019 |
| 58 |          |          |          |            |          |            |    1.588 |      1.186 |    1.392 |      2.004 |
| 59 |          |          |          |            |          |            |    1.581 |      1.184 |    1.388 |      1.991 |
| 60 |          |          |          |            |          |            |    1.575 |      1.181 |    1.384 |      1.978 |
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|

#+begin_src gnuplot :var data=Process-ONNX-python-Portability-new-Learning-rate :missing "?"  :file ../results/images/Process-ONNX-python-Portability-1e-7.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600 

  set title "Train and retraining loss for ONNX with python with learning rate 1e-7"  font ", 16"
  set size ratio square
  set key box linestyle -2 font ", 15"
  set key at graph 1.0, 1.0
  set key textcolor variable
  set xtics nomirror rotate by -45  font ", 12"

  set yrange [1:4]
  set ylabel "Loss" font ",14"
  set ytics nomirror rotate by -45 font ", 12"
  set style data lines
  plot  data u 1:2  with lp axis x1y1 lt 1 dashtype 1 lw 1  lc rgb '#ff0000' ps 1  pt 1 title '40% Training 1-20 Epochs' ,\
        data u 1:3  with lp axis x1y1 lt 1 dashtype 1 lw 1  lc rgb '#0000ff' ps 1  pt 1 title '60% Training 1-20 Epochs' ,\
        data u 1:4  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#ff0000' ps 1  pt 3 title '40% Resume   training 20-40 Epochs' ,\
        data u 1:5  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#ff8800' ps 2  pt 3 title '40% Ondevice training 20-40 Epochs' ,\
        data u 1:6  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#0000ff' ps 1  pt 3 title '60% Resuming training 20-40 Epochs' ,\
        data u 1:7  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#0077ff' ps 2  pt 3 title '60% Ondevice training 20-40 Epochs' ,\
        data u 1:8  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#ff0000' ps 1  pt 1 title '40% Resume   training 40-60 Epochs' ,\
        data u 1:9  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#ff8800' ps 2  pt 1 title '40% Ondevice training 40-60 Epochs' ,\
        data u 1:10 with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#0000ff' ps 1  pt 1 title '60% Resuming training 40-60 Epochs' ,\
        data u 1:11 with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#0077ff' ps 2  pt 1 title '60% Ondevice training 40-60 Epochs' 
#+end_src

#+RESULTS:
[[file:../results/images/Process-ONNX-python-Portability-1e-7.png]]



#+tblname: Process-ONNX-Acc-ReOntraining-Q-new-Learning-rate
|----+----------+----------+--------+-------+-----------+-----------+-----------+-----------|
| Nr | Onnx Acc | training | valida | tests | Re20infer | Re40infer | On20infer | On40infer |
|----+----------+----------+--------+-------+-----------+-----------+-----------+-----------|
|  1 | Un40Q    |    0.854 |  0.164 | 0.174 |     0.208 |     0.215 |     0.226 |     0.243 |
|  2 | Sh40Q    |    0.840 |  0.163 | 0.173 |     0.210 |     0.219 |     0.229 |      0.25 |
|  3 | Un60Q    |    0.854 |  0.164 | 0.177 |     0.203 |     0.211 |     0.207 |     0.208 |
|  4 | Sh60Q    |    0.853 |  0.177 | 0.176 |     0.214 |     0.219 |     0.204 |     0.215 |


#+begin_src gnuplot :var data=Process-ONNX-Acc-ReOntraining-Q-new-Learning-rate :missing "?"  :file ./thesis/results/images/Process-ONNX-train-Q-new-Learning-rate.png :exports none
  reset
  set terminal pngcairo enhanced size 800,650 

  set title "ONNX Performance of different inference cases for question"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 12"
  set key at graph 0.80, 0.25
  set key textcolor variable
  set xlabel "Shuffle-Partation-Evaluation" font ",16" offset 1, -1
  set xtics nomirror rotate by -45  font ", 12"

  set yrange [0.12:0.26]
  set ylabel "Accuracy" font ",14"
  set ytics nomirror rotate by -45 font ", 12"
  set style data lines
  plot  data u 4:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#000000' ps 2  pt 9  title 'model validation',\
        data u 5:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#000000' ps 2  pt 6  title 'ONNX inferenc',\
        data u 6:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#ff0000' ps 2  pt 9  title 'ONNX inferenc after resume training for 20 epochs',\
        data u 7:xticlabels(2) with lp axis x1y1 lt 2 dashtype 2 lw 1   lc rgb '#ff0000' ps 2  pt 6  title 'ONNX inferenc after resume training for 40 epochs',\
        data u 8:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#0000ff' ps 2  pt 9  title 'ONNX inferenc after ondevice training for 20 epochs',\
        data u 9:xticlabels(2) with lp axis x1y1 lt 2 dashtype 2 lw 1   lc rgb '#0000ff' ps 2  pt 6  title 'ONNX inferenc after ondevice training for 40 epochs'

#+end_src

#+RESULTS:
[[file:./thesis/results/images/Process-ONNX-train-Q-new-Learning-rate.png]]




#+tblname: Process-ONNX-Acc-ReOntraining-C-new-Learning-rate
|----+----------+----------+--------+-------+-----------+-----------+-----------+-----------|
| Nr | Onnx Acc | training | valida | tests | Re20infer | Re40infer | On20infer | On40infer |
|----+----------+----------+--------+-------+-----------+-----------+-----------+-----------|
|  1 | Un40C    |    0.843 |  0.341 | 0.328 |     0.519 |     0.587 |     0.636 |     0.695 |
|  2 | Sh40C    |    0.844 |  0.345 | 0.329 |     0.523 |     0.583 |     0.652 |     0.698 |
|  3 | Un60C    |    0.855 |  0.391 | 0.379 |     0.617 |     0.657 |     0.436 |     0.548 |
|  4 | Sh60C    |    0.855 |  0.390 | 0.388 |     0.630 |     0.672 |     0.476 |     0.575 |

#+begin_src gnuplot :var data=Process-ONNX-Acc-ReOntraining-C-new-Learning-rate :missing "?"  :file ./thesis/results/images/Process-ONNX-train-C-new-Learning-rate.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600 

  set title "ONNX Performance of different inference cases for conversation"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 12"
  set key at graph 1.0, 1.0
  set key textcolor variable
  set xlabel "Shuffle-Partation-Evaluation" font ",16" offset 1, -1
  set xtics nomirror rotate by -45  font ", 12"

  set yrange [0.3:0.85]
  set ylabel "Accuracy" font ",14"
  set ytics nomirror rotate by -45 font ", 12"
  set style data lines
  plot  data u 4:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#000000' ps 2  pt 9  title 'model validation',\
        data u 5:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#000000' ps 2  pt 6  title 'ONNX inferenc',\
        data u 6:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#ff0000' ps 2  pt 9  title 'ONNX inferenc after resume training for 20 epochs',\
        data u 7:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#ff0000' ps 2  pt 6  title 'ONNX inferenc after resume training for 40 epochs',\
        data u 8:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#0000ff' ps 2  pt 9  title 'ONNX inferenc after ondevice training for 20 epochs',\
        data u 9:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#0000ff' ps 2  pt 6  title 'ONNX inferenc after ondevice training for 40 epochs'

#+end_src

#+RESULTS:
[[file:./thesis/results/images/Process-ONNX-train-C-new-Learning-rate.png]]

*** Accuracy
#+ATTR_LATEX: :font \scriptsize
#+tblname: Process-ONNX-Acc
|----+----------+----------+--------+-------+-----------+-----------+-----------+-----------|
| Nr | Onnx Acc | training | valida | tests | Re20infer | Re40infer | On20infer | On40infer |
|----+----------+----------+--------+-------+-----------+-----------+-----------+-----------|
|  1 | Un40Q    |    0.854 |  0.164 | 0.174 |     0.199 |     0.185 |     0.210 |     0.205 |
|  2 | Un60Q    |    0.854 |  0.164 | 0.177 |     0.200 |     0.190 |     0.194 |     0.176 |
|  3 | Sh40Q    |    0.840 |  0.163 | 0.173 |     0.214 |     0.201 |     0.201 |     0.196 |
|  4 | Sh60Q    |    0.853 |  0.177 | 0.176 |     0.213 |     0.194 |     0.211 |     0.194 |
|  5 | Un40C    |    0.843 |  0.341 | 0.328 |     0.660 |     0.668 |     0.695 |     0.698 |
|  6 | Un60C    |    0.855 |  0.391 | 0.379 |     0.718 |     0.728 |     0.595 |     0.606 |
|  7 | Sh40C    |    0.844 |  0.345 | 0.329 |     0.640 |     0.658 |     0.705 |     0.705 |
|  8 | Sh60C    |    0.855 |  0.390 | 0.388 |     0.710 |     0.723 |     0.613 |     0.624 |


#+begin_src gnuplot :var data=Process-ONNX-Acc :missing "?"  :file ./thesis/results/images/Process-ONNX-train.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600 

  set title "ONNX Performance of training, validation and test"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 12"
  set key at graph 0.37, 1.0
  set key textcolor variable

  set xtics nomirror rotate by -45  font ", 12"

  set yrange [0.1:1]
  set ylabel "Accuracy" font ",14"
  set ytics nomirror rotate by -45 font ", 12"
  set style data lines
  plot  data u 3:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#000000' ps 1  pt 1  title 'train',\
        data u 4:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#0000ff' ps 2  pt 8  title 'valid',\
        data u 5:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#ff0000' ps 2  pt 9  title 'test'
#+end_src

#+RESULTS:
[[file:./thesis/results/images/Process-ONNX-train.png]]


#+ATTR_LATEX: :font \scriptsize
#+tblname: Process-ONNX-Acc-ReOntraining-Q
|----+----------+----------+--------+-------+-----------+-----------+-----------+-----------|
| Nr | Onnx Acc | training | valida | tests | Re20infer | Re40infer | On20infer | On40infer |
|----+----------+----------+--------+-------+-----------+-----------+-----------+-----------|
|  1 | Un40Q    |    0.854 |  0.164 | 0.174 |     0.199 |     0.185 |     0.210 |     0.205 |
|  2 | Sh40Q    |    0.840 |  0.163 | 0.173 |     0.214 |     0.201 |     0.201 |     0.196 |
|  3 | Un60Q    |    0.854 |  0.164 | 0.177 |    0.2000 |     0.190 |     0.194 |     0.176 |
|  4 | Sh60Q    |    0.853 |  0.177 | 0.176 |     0.213 |     0.194 |     0.211 |     0.194 |

#+begin_src gnuplot :var data=Process-ONNX-Acc-ReOntraining-Q :missing "?"  :file ./thesis/results/images/Process-ONNX-train-Q.png :exports none
   reset
   set terminal pngcairo enhanced size 800,650 

   set title "Evaluation performance of question after retraining with ONNX"  font ", 14"
   set size ratio square
   set key box linestyle -2 font ", 14"
   set key at graph 0.90, 0.28
   set key textcolor variable
   set xlabel "Shuffle-Partation-Evaluation" font ",16" offset 1, -1
   set xtics nomirror rotate by -45  font ", 14"

   set yrange [0.14:0.22]
   set ylabel "Accuracy" font ",14"
   set ytics nomirror rotate by -45 font ", 14"
   set style data lines
   plot  data u 4:xticlabels(2) with lp axis x1y1 lt 1 dashtype 3 lw 2   lc rgb '#000000' ps 2  pt 9  title 'model validation',\
         data u 5:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#000000' ps 2  pt 6  title 'ONNX inference',\
         data u 6:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#ff0000' ps 2  pt 9  title 'ONNX inferenc after resume training for 20 epochs',\
         data u 7:xticlabels(2) with lp axis x1y1 lt 2 dashtype 1 lw 2   lc rgb '#ff0000' ps 2  pt 6  title 'ONNX inferenc after resume training for 40 epochs',\
         data u 8:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#0000ff' ps 2  pt 9  title 'ONNX inferenc after ondevice training for 20 epochs',\
         data u 9:xticlabels(2) with lp axis x1y1 lt 2 dashtype 1 lw 2   lc rgb '#0000ff' ps 2  pt 6  title 'ONNX inferenc after ondevice training for 40 epochs'

#+end_src

#+RESULTS:
[[file:./thesis/results/images/Process-ONNX-train-Q.png]]



#+ATTR_LATEX: :font \scriptsize
#+tblname: Process-ONNX-Acc-ReOntraining-C
|----+----------+----------+--------+-------+-----------+-----------+-----------+-----------|
| Nr | Onnx Acc | training | valida | tests | Re20infer | Re40infer | On20infer | On40infer |
|----+----------+----------+--------+-------+-----------+-----------+-----------+-----------|
|  1 | Un40C    |    0.843 |  0.341 | 0.328 |     0.660 |     0.668 |     0.695 |     0.698 |
|  2 | Sh40C    |    0.844 |  0.345 | 0.329 |     0.640 |     0.658 |     0.705 |     0.705 |
|  3 | Un60C    |    0.855 |  0.391 | 0.379 |     0.718 |     0.728 |     0.595 |     0.606 |
|  4 | Sh60C    |    0.855 |  0.390 | 0.388 |     0.710 |     0.723 |     0.613 |     0.624 |

#+begin_src gnuplot :var data=Process-ONNX-Acc-ReOntraining-C :missing "?"  :file ./thesis/results/images/Process-ONNX-train-C.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600 

  set title "Evaluation performance of conversation after retraining with ONNX"  font ", 16"
  set size ratio square
  set key box linestyle -2 font ", 14"
  set key at graph 0.90, 0.63
  set key textcolor variable
  set xlabel "Shuffle-Partation-Evaluation" font ",16" offset 1, -1
  set xtics nomirror rotate by -45  font ", 14"

  set yrange [0.25:0.75]
  set ylabel "Accuracy" font ",14"
  set ytics nomirror rotate by -45 font ", 14"
  set style data lines
  plot  data u 4:xticlabels(2) with lp axis x1y1 lt 1 dashtype 3 lw 2   lc rgb '#000000' ps 2  pt 9  title 'model validation',\
        data u 5:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#000000' ps 2  pt 6  title 'ONNX inference',\
        data u 6:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#ff0000' ps 2  pt 9  title 'ONNX inferenc after resume training for 20 epochs',\
        data u 7:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#ff0000' ps 2  pt 6  title 'ONNX inferenc after resume training for 40 epochs',\
        data u 8:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#0000ff' ps 2  pt 9  title 'ONNX inferenc after ondevice training for 20 epochs',\
        data u 9:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#0000ff' ps 2  pt 6  title 'ONNX inferenc after ondevice training for 40 epochs'

#+end_src

#+RESULTS:
[[file:./thesis/results/images/Process-ONNX-train-C.png]]

*** Loss
#+ATTR_LATEX: :font \scriptsize
#+tblname: Process-ONNX-Loss
|----+-----------+-------+-------+-------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------|
| Nr | Onnx Loss | Train | Valid |  test | Re20train | Re20valid | Re40train | Re40valid | On20train | On20valid | On40train | On40valid |
|----+-----------+-------+-------+-------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------|
|  1 | Un40Q     | 0.734 | 3.535 | 3.546 |     0.174 |     4.670 |     0.161 |     6.050 |     0.208 |     4.722 |     0.178 |     6.117 |
|  2 | Sh40Q     | 0.807 | 3.526 | 3.538 |     0.174 |     4.403 |     0.161 |     5.712 |     0.207 |     4.542 |     0.179 |     5.997 |
|  3 | Un60Q     | 0.734 | 3.535 | 3.502 |     0.177 |     4.725 |     0.162 |     6.291 |     0.238 |     4.681 |     0.194 |     6.137 |
|  4 | Sh60Q     | 0.737 | 3.559 | 3.548 |     0.177 |     4.509 |     0.193 |     6.199 |     0.240 |     4.633 |     0.193 |     6.199 |
|----+-----------+-------+-------+-------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------|
|  5 | Un40C     | 0.808 |       | 2.719 |     0.174 |     1.513 |     0.161 |     1.637 |     0.209 |     1.237 |     0.179 |     1.414 |
|  6 | Sh40C     | 0.805 | 2.613 | 2.700 |     0.174 |     1.530 |     0.161 |     1.664 |     0.208 |     1.204 |     0.179 |     1.385 |
|  7 | Un60C     | 0.738 | 2.426 | 2.419 |     0.177 |     1.337 |     0.164 |     1.467 |     0.241 |     1.821 |     0.194 |     2.010 |
|  8 | Sh60C     | 0.727 | 2.390 | 2.378 |     0.177 |     1.335 |     0.163 |     1.456 |     0.237 |     1.796 |     0.194 |     1.994 |
|----+-----------+-------+-------+-------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------|

#+begin_src gnuplot :var data=Process-ONNX-Loss :missing "?"  :file ../results/images/Process-ONNX-Loss-training.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600 

  set title "ONNX loss Performance for Training, resuming training and ondevice training"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 12"
  set key at graph 0.37, 1.0
  set key textcolor variable

  set xtics nomirror rotate by -45  font ", 12"

  set yrange [0:1]
  set ylabel "Loss" font ",14"
  set ytics nomirror rotate by -45 font ", 12"
  set style data lines
  plot  data u 3:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#000000' ps 2  pt 1  title 'train',\
        data u 6:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#0000ff' ps 2  pt 9  title 'trainRe20',\
        data u 8:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#0000ff' ps 2  pt 3  title 'trainRe40',\
        data u 10:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#ff0000' ps 2  pt 9  title 'trainOn20',\
        data u 12:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#ff0000' ps 2  pt 3  title 'trainOn40'
#+end_src

#+ATTR_LATEX:  :scale 0.35
[[file:../results/images/Process-ONNX-Loss-training.png]]

#+begin_src gnuplot :var data=Process-ONNX-Loss :missing "?"  :file ../results/images/Process-ONNX-Loss-validation.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600 

  set title "ONNX loss validation Performance for Training, resuming training and ondevice training"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 12"
  set key at graph 0.95, 1.0
  set key textcolor variable

  set xtics nomirror rotate by -45  font ", 12"

  set yrange [0:7]
  set ylabel "Loss" font ",14"
  set ytics nomirror rotate by -45 font ", 12"
  set style data lines
  plot  data u 4:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#000000' ps 2  pt 1  title 'train',\
        data u 7:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#0000ff' ps 2  pt 9  title 'trainRe20',\
        data u 9:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#0000ff' ps 2  pt 3  title 'trainRe40',\
        data u 11:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#ff0000' ps 2  pt 9  title 'trainOn20',\
        data u 13:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#ff0000' ps 2  pt 3  title 'trainOn40'
#+end_src

#+RESULTS:
[[file:../results/images/Process-ONNX-Loss-validation.png]]

#+ATTR_LATEX:  :scale 0.35
[[file:../results/images/Process-ONNX-Loss-validation.png]]

** C/C++
*** Portability 5e-7
#+tblname: Process-ONNX-C++-Portability
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|
|  0 | resume40 | resume60 | resume40 | ondevice40 | resume60 | ondevice60 | resume40 | ondevice40 | resume60 | ondevice60 |
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|
|  1 |   3.5328 |   3.4151 |          |            |          |            |          |            |          |            |
|  2 |   3.3647 |   3.2222 |          |            |          |            |          |            |          |            |
|  3 |   3.2477 |   3.0831 |          |            |          |            |          |            |          |            |
|  4 |   3.1476 |   2.9745 |          |            |          |            |          |            |          |            |
|  5 |   3.0698 |    2.886 |          |            |          |            |          |            |          |            |
|  6 |   2.9999 |   2.8116 |          |            |          |            |          |            |          |            |
|  7 |   2.9424 |   2.7564 |          |            |          |            |          |            |          |            |
|  8 |   2.8879 |   2.7022 |          |            |          |            |          |            |          |            |
|  9 |   2.8472 |   2.6616 |          |            |          |            |          |            |          |            |
| 10 |   2.8106 |   2.6215 |          |            |          |            |          |            |          |            |
| 11 |   2.7817 |   2.5882 |          |            |          |            |          |            |          |            |
| 12 |   2.7524 |   2.5601 |          |            |          |            |          |            |          |            |
| 13 |   2.7279 |   2.5314 |          |            |          |            |          |            |          |            |
| 14 |   2.7061 |    2.504 |          |            |          |            |          |            |          |            |
| 15 |   2.6898 |   2.4856 |          |            |          |            |          |            |          |            |
| 16 |    2.672 |   2.4596 |          |            |          |            |          |            |          |            |
| 17 |   2.6537 |   2.4428 |          |            |          |            |          |            |          |            |
| 18 |   2.6401 |   2.4241 |          |            |          |            |          |            |          |            |
| 19 |    2.627 |   2.4028 |          |            |          |            |          |            |          |            |
| 20 |   2.6137 |   2.3902 |          |            |          |            |          |            |          |            |
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|
| 21 |          |          |     2.58 |       2.50 |     2.10 |       2.35 |          |            |          |            |
| 22 |          |          |     2.32 |       2.06 |     1.78 |       2.31 |          |            |          |            |
| 23 |          |          |     2.05 |       1.71 |     1.63 |       2.25 |          |            |          |            |
| 24 |          |          |     1.91 |       1.51 |     1.54 |       2.17 |          |            |          |            |
| 25 |          |          |     1.82 |       1.41 |     1.48 |       2.06 |          |            |          |            |
| 26 |          |          |     1.76 |       1.36 |     1.44 |       1.97 |          |            |          |            |
| 27 |          |          |     1.71 |       1.33 |     1.41 |       1.90 |          |            |          |            |
| 28 |          |          |     1.68 |       1.31 |     1.39 |       1.85 |          |            |          |            |
| 29 |          |          |     1.66 |       1.30 |     1.37 |       1.81 |          |            |          |            |
| 30 |          |          |     1.64 |       1.29 |     1.36 |       1.78 |          |            |          |            |
| 31 |          |          |     1.63 |       1.29 |     1.35 |       1.76 |          |            |          |            |
| 32 |          |          |     1.62 |       1.29 |     1.34 |       1.75 |          |            |          |            |
| 33 |          |          |     1.61 |       1.29 |     1.33 |       1.74 |          |            |          |            |
| 34 |          |          |     1.61 |       1.29 |     1.33 |       1.73 |          |            |          |            |
| 35 |          |          |     1.61 |       1.29 |     1.33 |       1.73 |          |            |          |            |
| 36 |          |          |     1.60 |       1.29 |     1.33 |       1.73 |          |            |          |            |
| 37 |          |          |     1.61 |       1.30 |     1.33 |       1.74 |          |            |          |            |
| 38 |          |          |     1.61 |       1.31 |     1.33 |       1.74 |          |            |          |            |
| 39 |          |          |     1.61 |       1.31 |     1.33 |       1.75 |          |            |          |            |
| 40 |          |          |     1.61 |       1.32 |     1.33 |       1.76 |          |            |          |            |
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|
| 41 |          |          |          |            |          |            |     1.62 |       1.33 |     1.34 |       1.76 |
| 42 |          |          |          |            |          |            |     1.62 |       1.34 |     1.34 |       1.77 |
| 43 |          |          |          |            |          |            |     1.63 |       1.35 |     1.35 |       1.78 |
| 44 |          |          |          |            |          |            |     1.63 |       1.36 |     1.36 |       1.79 |
| 45 |          |          |          |            |          |            |     1.64 |       1.37 |     1.36 |       1.81 |
| 46 |          |          |          |            |          |            |     1.65 |       1.38 |     1.37 |       1.82 |
| 47 |          |          |          |            |          |            |     1.65 |       1.39 |     1.38 |       1.83 |
| 48 |          |          |          |            |          |            |     1.66 |       1.40 |     1.38 |       1.84 |
| 49 |          |          |          |            |          |            |     1.67 |       1.41 |     1.39 |       1.85 |
| 50 |          |          |          |            |          |            |     1.68 |       1.42 |     1.40 |       1.87 |
| 51 |          |          |          |            |          |            |     1.68 |       1.43 |     1.41 |       1.88 |
| 52 |          |          |          |            |          |            |     1.69 |       1.44 |     1.41 |       1.89 |
| 53 |          |          |          |            |          |            |     1.70 |       1.45 |     1.42 |       1.91 |
| 54 |          |          |          |            |          |            |     1.70 |       1.46 |     1.43 |       1.92 |
| 55 |          |          |          |            |          |            |     1.71 |       1.47 |     1.44 |       1.93 |
| 56 |          |          |          |            |          |            |     1.72 |       1.48 |     1.45 |       1.94 |
| 57 |          |          |          |            |          |            |     1.72 |       1.49 |     1.46 |       1.96 |
| 58 |          |          |          |            |          |            |     1.73 |       1.49 |     1.47 |       1.97 |
| 59 |          |          |          |            |          |            |     1.74 |       1.50 |     1.48 |       1.98 |
| 60 |          |          |          |            |          |            |     1.74 |       1.51 |     1.49 |       1.99 |
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|


#+begin_src gnuplot :var data=Process-ONNX-C++-Portability :missing "?"  :file ../results/images/Process-ONNX-C++-Portability-5e-7.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600 

  set title "Train and retraining loss for ONNX with C++ with learning rate 5e-7"  font ", 16"
  set size ratio square
  set key box linestyle -2 font ", 14"
  set key at graph 1.0, 1.0
  set key textcolor variable
  set xtics nomirror rotate by -45  font ", 12"

  set yrange [1:4]
  set ylabel "Loss" font ",14"
  set ytics nomirror rotate by -45 font ", 12"
  set style data lines
  plot  data u 1:2  with lp axis x1y1 lt 1 dashtype 1 lw 1  lc rgb '#ff0000' ps 1  pt 1 title '40% Training 1-20 Epochs' ,\
        data u 1:3  with lp axis x1y1 lt 1 dashtype 1 lw 1  lc rgb '#0000ff' ps 1  pt 1 title '60% Training 1-20 Epochs' ,\
        data u 1:4  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#ff0000' ps 1  pt 3 title '40% Resume   training 20-40 Epochs' ,\
        data u 1:5  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#ff8800' ps 2  pt 3 title '40% Ondevice training 20-40 Epochs' ,\
        data u 1:6  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#0000ff' ps 1  pt 3 title '60% Resuming training 20-40 Epochs' ,\
        data u 1:7  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#0077ff' ps 2  pt 3 title '60% Ondevice training 20-40 Epochs' ,\
        data u 1:8  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#ff0000' ps 1  pt 1 title '40% Resume   training 40-60 Epochs' ,\
        data u 1:9  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#ff8800' ps 2  pt 1 title '40% Ondevice training 40-60 Epochs' ,\
        data u 1:10 with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#0000ff' ps 1  pt 1 title '60% Resuming training 40-60 Epochs' ,\
        data u 1:11 with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#0077ff' ps 2  pt 1 title '60% Ondevice training 40-60 Epochs' 
#+end_src

#+RESULTS:
[[file:../results/images/Process-ONNX-C++-Portability-5e-7.png]]

*** Portability 1e-7
#+tblname: Process-ONNX-C++-Portability-1e-7
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|
|  0 | resume40 | resume60 | resume40 | ondevice40 | resume60 | ondevice60 | resume40 | ondevice40 | resume60 | ondevice60 |
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|
|  1 |   3.5328 |   3.4151 |          |            |          |            |          |            |          |            |
|  2 |   3.3647 |   3.2222 |          |            |          |            |          |            |          |            |
|  3 |   3.2477 |   3.0831 |          |            |          |            |          |            |          |            |
|  4 |   3.1476 |   2.9745 |          |            |          |            |          |            |          |            |
|  5 |   3.0698 |    2.886 |          |            |          |            |          |            |          |            |
|  6 |   2.9999 |   2.8116 |          |            |          |            |          |            |          |            |
|  7 |   2.9424 |   2.7564 |          |            |          |            |          |            |          |            |
|  8 |   2.8879 |   2.7022 |          |            |          |            |          |            |          |            |
|  9 |   2.8472 |   2.6616 |          |            |          |            |          |            |          |            |
| 10 |   2.8106 |   2.6215 |          |            |          |            |          |            |          |            |
| 11 |   2.7817 |   2.5882 |          |            |          |            |          |            |          |            |
| 12 |   2.7524 |   2.5601 |          |            |          |            |          |            |          |            |
| 13 |   2.7279 |   2.5314 |          |            |          |            |          |            |          |            |
| 14 |   2.7061 |    2.504 |          |            |          |            |          |            |          |            |
| 15 |   2.6898 |   2.4856 |          |            |          |            |          |            |          |            |
| 16 |    2.672 |   2.4596 |          |            |          |            |          |            |          |            |
| 17 |   2.6537 |   2.4428 |          |            |          |            |          |            |          |            |
| 18 |   2.6401 |   2.4241 |          |            |          |            |          |            |          |            |
| 19 |    2.627 |   2.4028 |          |            |          |            |          |            |          |            |
| 20 |   2.6137 |   2.3902 |          |            |          |            |          |            |          |            |
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|
| 21 |          |          |     2.65 |       2.64 |     2.32 |       2.33 |          |            |          |            |
| 22 |          |          |     2.63 |       2.61 |     2.28 |       2.32 |          |            |          |            |
| 23 |          |          |     2.60 |       2.58 |     2.23 |       2.32 |          |            |          |            |
| 24 |          |          |     2.57 |       2.54 |     2.16 |       2.32 |          |            |          |            |
| 25 |          |          |     2.54 |       2.49 |     2.07 |       2.31 |          |            |          |            |
| 26 |          |          |     2.51 |       2.42 |     1.98 |       2.31 |          |            |          |            |
| 27 |          |          |     2.47 |       2.34 |     1.90 |       2.31 |          |            |          |            |
| 28 |          |          |     2.42 |       2.25 |     1.83 |       2.30 |          |            |          |            |
| 29 |          |          |     2.37 |       2.14 |     1.78 |       2.30 |          |            |          |            |
| 30 |          |          |     2.31 |       2.04 |     1.74 |       2.29 |          |            |          |            |
| 31 |          |          |     2.24 |       1.95 |     1.70 |       2.28 |          |            |          |            |
| 32 |          |          |     2.18 |       1.87 |     1.67 |       2.28 |          |            |          |            |
| 33 |          |          |     2.12 |       1.80 |     1.64 |       2.27 |          |            |          |            |
| 34 |          |          |     2.08 |       1.74 |     1.62 |       2.26 |          |            |          |            |
| 35 |          |          |     2.03 |       1.68 |     1.59 |       2.25 |          |            |          |            |
| 36 |          |          |     2.00 |       1.63 |     1.58 |       2.23 |          |            |          |            |
| 37 |          |          |     1.96 |       1.59 |     1.56 |       2.22 |          |            |          |            |
| 38 |          |          |     1.93 |       1.55 |     1.54 |       2.20 |          |            |          |            |
| 39 |          |          |     1.91 |       1.51 |     1.53 |       2.19 |          |            |          |            |
| 40 |          |          |     1.88 |       1.48 |     1.51 |       2.17 |          |            |          |            |
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|
| 41 |          |          |          |            |          |            |     1.86 |       1.46 |     1.50 |       2.15 |
| 42 |          |          |          |            |          |            |     1.84 |       1.44 |     1.49 |       2.13 |
| 43 |          |          |          |            |          |            |     1.82 |       1.42 |     1.48 |       2.11 |
| 44 |          |          |          |            |          |            |     1.81 |       1.40 |     1.47 |       2.09 |
| 45 |          |          |          |            |          |            |     1.79 |       1.38 |     1.46 |       2.07 |
| 46 |          |          |          |            |          |            |     1.78 |       1.37 |     1.45 |       2.04 |
| 47 |          |          |          |            |          |            |     1.76 |       1.36 |     1.44 |       2.02 |
| 48 |          |          |          |            |          |            |     1.75 |       1.35 |     1.43 |       2.00 |
| 49 |          |          |          |            |          |            |     1.74 |       1.34 |     1.43 |       1.99 |
| 50 |          |          |          |            |          |            |     1.73 |       1.33 |     1.42 |       1.97 |
| 51 |          |          |          |            |          |            |     1.72 |       1.33 |     1.41 |       1.95 |
| 52 |          |          |          |            |          |            |     1.71 |       1.32 |     1.41 |       1.93 |
| 53 |          |          |          |            |          |            |     1.70 |       1.32 |     1.40 |       1.92 |
| 54 |          |          |          |            |          |            |     1.70 |       1.31 |     1.40 |       1.90 |
| 55 |          |          |          |            |          |            |     1.69 |       1.31 |     1.39 |       1.89 |
| 56 |          |          |          |            |          |            |     1.68 |       1.30 |     1.39 |       1.88 |
| 57 |          |          |          |            |          |            |     1.68 |       1.30 |     1.38 |       1.87 |
| 58 |          |          |          |            |          |            |     1.67 |       1.29 |     1.38 |       1.86 |
| 59 |          |          |          |            |          |            |     1.66 |       1.29 |     1.37 |       1.85 |
| 60 |          |          |          |            |          |            |     1.66 |       1.29 |     1.37 |       1.84 |
|----+----------+----------+----------+------------+----------+------------+----------+------------+----------+------------|

#+begin_src gnuplot :var data=Process-ONNX-C++-Portability-1e-7 :missing "?"  :file ../results/images/Process-ONNX-C++-Portability-1e-7.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600 

  set title "Train and retraining loss for ONNX with C++ with learning rate 1e-7"  font ", 16"
  set size ratio square
  set key box linestyle -2 font ", 14"
  set key at graph 1.0, 1.0
  set key textcolor variable
  set xtics nomirror rotate by -45  font ", 12"

  set yrange [1:4]
  set ylabel "Loss" font ",14"
  set ytics nomirror rotate by -45 font ", 12"
  set style data lines
  plot  data u 1:2  with lp axis x1y1 lt 1 dashtype 1 lw 1  lc rgb '#ff0000' ps 1  pt 1 title '40% Training 1-20 Epochs' ,\
        data u 1:3  with lp axis x1y1 lt 1 dashtype 1 lw 1  lc rgb '#0000ff' ps 1  pt 1 title '60% Training 1-20 Epochs' ,\
        data u 1:4  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#ff0000' ps 1  pt 3 title '40% Resume   training 20-40 Epochs' ,\
        data u 1:5  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#ff8800' ps 2  pt 3 title '40% Ondevice training 20-40 Epochs' ,\
        data u 1:6  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#0000ff' ps 1  pt 3 title '60% Resuming training 20-40 Epochs' ,\
        data u 1:7  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#0077ff' ps 2  pt 3 title '60% Ondevice training 20-40 Epochs' ,\
        data u 1:8  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#ff0000' ps 1  pt 1 title '40% Resume   training 40-60 Epochs' ,\
        data u 1:9  with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#ff8800' ps 2  pt 1 title '40% Ondevice training 40-60 Epochs' ,\
        data u 1:10 with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#0000ff' ps 1  pt 1 title '60% Resuming training 40-60 Epochs' ,\
        data u 1:11 with lp axis x1y1 lt 1 dashtype 3 lw 1  lc rgb '#0077ff' ps 2  pt 1 title '60% Ondevice training 40-60 Epochs' 
#+end_src

#+RESULTS:
[[file:../results/images/Process-ONNX-C++-Portability-1e-7.png]]



*** Accuracy
#+ATTR_LATEX: :font \scriptsize
#+tblname: Process-ONNX-Acc-C++
|----+----------+----------+--------+-------+-----------+-----------+-----------+-----------|
| Nr | Onnx Acc | training | valida | tests | Re20infer | Re40infer | On20infer | On40infer |
|----+----------+----------+--------+-------+-----------+-----------+-----------+-----------|
|  1 | Un40Q    |    0.854 |  0.164 | 0.154 |     0.208 |     0.219 |     0.226 |     0.243 |
|  2 | Un60Q    |    0.854 |  0.164 | 0.169 |     0.203 |     0.211 |     0.207 |     0.208 |
|  3 | Sh40Q    |    0.840 |  0.163 | 0.170 |     0.210 |     0.219 |     0.229 |      0.25 |
|  4 | Sh60Q    |    0.853 |  0.177 | 0.176 |     0.214 |     0.219 |     0.204 |     0.215 |
|  5 | Un40C    |    0.843 |  0.341 | 0.327 |     0.519 |     0.587 |     0.636 |     0.695 |
|  6 | Un60C    |    0.855 |  0.391 | 0.379 |     0.617 |     0.657 |     0.436 |     0.548 |
|  7 | Sh40C    |    0.844 |  0.345 | 0.329 |     0.523 |     0.583 |     0.652 |     0.698 |
|  8 | Sh60C    |    0.855 |  0.390 | 0.381 |     0.630 |     0.672 |     0.476 |     0.575 |


#+begin_src gnuplot :var data=Process-ONNX-Acc-C++ :missing "?"  :file ./thesis/results/images/Process-ONNX-train-C++.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600 

  set title "ONNX Performance of training, validation and test"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 12"
  set key at graph 0.37, 1.0
  set key textcolor variable
  set xlabel "Shuffle-Partation-Evaluation" font ",16" offset 1, -1
  set xtics nomirror rotate by -45  font ", 12"

  set yrange [0.1:1]
  set ylabel "Accuracy" font ",14"
  set ytics nomirror rotate by -45 font ", 12"
  set style data lines
  plot  data u 3:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#000000' ps 1  pt 1  title 'train',\
        data u 4:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1   lc rgb '#0000ff' ps 2  pt 8  title 'valid',\
        data u 5:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1   lc rgb '#ff0000' ps 2  pt 9  title 'test'
#+end_src

#+RESULTS:
[[file:./thesis/results/images/Process-ONNX-train-C++.png]]

#+ATTR_LATEX: :font \scriptsize
#+tblname: Process-ONNX-Acc-ReOntraining-Q-C++
|----+--------------+----------+--------+-------+-----------+-----------+-----------+-----------|
| Nr | Onnx Acc     | training | valida | tests | Re20infer | Re40infer | On20infer | On40infer |
|----+--------------+----------+--------+-------+-----------+-----------+-----------+-----------|
|  1 | Un40Q        |    0.854 |  0.164 | 0.154 |     0.208 |     0.219 |     0.226 |     0.243 |
|  2 | Sh40Q        |    0.840 |  0.163 | 0.170 |     0.210 |     0.219 |     0.229 |      0.25 |
|  3 | Un60Q        |    0.854 |  0.164 | 0.169 |     0.203 |     0.211 |     0.207 |     0.208 |
|  4 | Sh60Q        |    0.853 |  0.177 | 0.176 |     0.214 |     0.219 |     0.204 |     0.215 |

#+begin_src gnuplot :var data=Process-ONNX-Acc-ReOntraining-Q-C++ :missing "?"  :file ./thesis/results/images/Process-ONNX-train-Q-C++.png :exports none
  reset
  set terminal pngcairo enhanced size 800,650 

  set title "Evaluation performance of question after retraining with ONNX"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 14"
  set key at graph 0.90, 0.51
  set key textcolor variable
  set xlabel "Shuffle-Partation-Evaluation" font ",16" offset 1, -1
  set xtics nomirror rotate by -45  font ", 14"

  set yrange [0.15:0.25]
  set ylabel "Accuracy" font ",14"
  set ytics nomirror rotate by -45 font ", 14"
  set style data lines
  plot  data u 4:xticlabels(2) with lp axis x1y1 lt 1 dashtype 3 lw 2   lc rgb '#000000' ps 2  pt 9  title 'model validation',\
        data u 5:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#000000' ps 2  pt 6  title 'ONNX inferenc',\
        data u 6:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#ff0000' ps 2  pt 9  title 'ONNX inferenc after resume training for 20 epochs',\
        data u 7:xticlabels(2) with lp axis x1y1 lt 2 dashtype 1 lw 2   lc rgb '#ff0000' ps 2  pt 6  title 'ONNX inferenc after resume training for 40 epochs',\
        data u 8:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#0000ff' ps 2  pt 9  title 'ONNX inferenc after ondevice training for 20 epochs',\
        data u 9:xticlabels(2) with lp axis x1y1 lt 2 dashtype 1 lw 2   lc rgb '#0000ff' ps 2  pt 6  title 'ONNX inferenc after ondevice training for 40 epochs'

#+end_src

#+RESULTS:
[[file:./thesis/results/images/Process-ONNX-train-Q-C++.png]]



#+ATTR_LATEX: :font \scriptsize
#+tblname: Process-ONNX-Acc-ReOntraining-C-C++
|----+--------------+----------+--------+-------+-----------+-----------+-----------+-----------|
| Nr | Onnx Acc     | training | valida | tests | Re20infer | Re40infer | On20infer | On40infer |
|----+--------------+----------+--------+-------+-----------+-----------+-----------+-----------|
|  1 | Un40C        |    0.843 |  0.341 | 0.327 |     0.519 |     0.587 |     0.636 |     0.695 |
|  2 | Sh40C        |    0.844 |  0.345 | 0.329 |     0.523 |     0.583 |     0.652 |     0.698 |
|  3 | Un60C        |    0.855 |  0.391 | 0.379 |     0.617 |     0.657 |     0.436 |     0.548 |
|  4 | Sh60C        |    0.855 |  0.390 | 0.381 |     0.630 |     0.672 |     0.476 |     0.575 |

#+begin_src gnuplot :var data=Process-ONNX-Acc-ReOntraining-C-C++ :missing "?"  :file ./thesis/results/images/Process-ONNX-train-C-C++.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600 

  set title "Evaluation performance of conversation after retraining with ONNX"  font ", 16"
  set size ratio square
  set key box linestyle -2 font ", 14"
  set key at graph 0.90, 0.3
  set key textcolor variable
  set xlabel "Shuffle-Partation-Evaluation" font ",16" offset 1, -1
  set xtics nomirror rotate by -45  font ", 14"

  set yrange [0.15:0.75]
  set ylabel "Accuracy" font ",14"
  set ytics nomirror rotate by -45 font ", 14"
  set style data lines
  plot  data u 4:xticlabels(2) with lp axis x1y1 lt 1 dashtype 3 lw 2   lc rgb '#000000' ps 2  pt 9  title 'model validation',\
        data u 5:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#000000' ps 2  pt 6  title 'ONNX inferenc',\
        data u 6:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#ff0000' ps 2  pt 9  title 'ONNX inferenc after resume training for 20 epochs',\
        data u 7:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#ff0000' ps 2  pt 6  title 'ONNX inferenc after resume training for 40 epochs',\
        data u 8:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#0000ff' ps 2  pt 9  title 'ONNX inferenc after ondevice training for 20 epochs',\
        data u 9:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#0000ff' ps 2  pt 6  title 'ONNX inferenc after ondevice training for 40 epochs'

#+end_src

#+RESULTS:
[[file:./thesis/results/images/Process-ONNX-train-C-C++.png]]

*** Loss
*** Time
** Rust?
** Time
*** Python ONNX training
#+ATTR_LATEX: :font \scriptsize
#+tblname: Python-ONNX-Time-Training
|----+-----------+----------+------+------+------+------|
| Nr | Onnx Time | training | Re20 | Re40 | On20 | On40 |
|----+-----------+----------+------+------+------+------|
|  1 | Un40Q     |     2423 |  910 | 1448 |  916 | 1608 |
|  2 | Sh40Q     |     2316 |  909 | 1614 |  906 | 1619 |
|  3 | Un40C     |     2352 |  910 | 1608 |  898 | 1616 |
|  4 | Sh40C     |     2361 |  618 | 1462 |  625 | 1206 |
|----+-----------+----------+------+------+------+------|
|  5 | Un60Q     |     3423 | 1170 | 2352 |  316 |  465 |
|  6 | Un60C     |     3439 | 1297 | 2311 |  313 |  526 |
|  7 | Sh60Q     |     3457 | 1295 | 2336 |  313 |  529 |
|  8 | Sh60C     |     3435 | 1307 | 2344 |  319 |  531 |
|----+-----------+----------+------+------+------+------|

#+begin_src gnuplot :var data=Python-ONNX-Time-Training :missing "?"  :file ../results/images/Python-ONNX-Time-training.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600 

  set title "Pytorch time comsumption for different training phases"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 16"
  set key at graph 0.5, 1.0
  set key textcolor variable
  set xlabel "Shuffle-Partation-Evaluation" font ",16" offset 1, -1
  set xtics nomirror rotate by -15  font ", 14"

  set yrange [0:3500]
  set ylabel "Time consumption" font ",16"  offset -1, 1
  set ytics nomirror rotate by -45 font ", 14"
  set style data lines
  plot  data u 3:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#000000' ps 2  pt 1  title 'Model train',\
        data u 4:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#ff0000' ps 2  pt 9  title 'Resume training 20',\
        data u 5:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#ff0000' ps 2  pt 3  title 'Resume training 40',\
        data u 6:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#0000ff' ps 2  pt 9  title 'Ondevice training 20',\
        data u 7:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#0000ff' ps 2  pt 3  title 'Ondevice training 40'
#+end_src

#+RESULTS:
[[file:../results/images/Python-ONNX-Time-training.png]]

*** ONNX Type Inference
#+tblname: ONNX-Type-Inference-Languages
|    | Language |    PyTorch |    PyTorch |    PyTorch | Python |      Python |    C++ |         C++ |
| Nr | ONNX     | state dict | whole mode | checkpoint | Dynamo | TorchScript | Dynamo | TorchScript |
|----+----------+------------+------------+------------+--------+-------------+--------+-------------|
|  1 | Un40Q    |         41 |         40 |         41 |    4.3 |         2.1 |     73 |          84 |
|  2 | Sh40Q    |         41 |         40 |         42 |    5.4 |         2.7 |     73 |          84 |
|  3 | Un40C    |         42 |         41 |         42 |    5.6 |         2.7 |     74 |          85 |
|  4 | Sh40C    |         41 |         40 |         42 |    6.0 |         2.8 |     73 |          85 |
|----+----------+------------+------------+------------+--------+-------------+--------+-------------|
|  5 | Un60Q    |         41 |         40 |         42 |    5.4 |         2.7 |     73 |          86 |
|  6 | Sh60Q    |         29 |         26 |         29 |    5.5 |         2.7 |     72 |          84 |
|  7 | Un60C    |         42 |         40 |         42 |    5.4 |         2.7 |     75 |          85 |
|  8 | Sh60C    |         41 |         40 |         42 |    5.4 |         2.7 |     72 |          83 |
|----+----------+------------+------------+------------+--------+-------------+--------+-------------|


#+begin_src gnuplot :var data=ONNX-Type-Inference-Languages :missing "?"  :file ./thesis/results/images/ONNX-Type-Inference-Languages.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600 

  set title "Inference with two kinds ONNX formats and saved PyTorch model"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 13"
  set key at graph 0.45, 0.40
  set key textcolor variable
  set xlabel "Shuffle-Partation-Evaluation strategy" font ",16" offset 1, -1
  set xtics nomirror rotate by -15  font ", 14"

  set yrange [0:90]
  set ylabel "Time consumption in minutes" font ",16" offset -1, 1
  set ytics nomirror rotate by -45 font ", 14"
  set style data lines
  plot  data u 3:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#000000' ps 2  pt 1  title 'PyTorch state dict',\
        data u 4:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#000000' ps 2  pt 9  title 'PyTorch whole model',\
        data u 5:xticlabels(2) with lp axis x1y1 lt 1 dashtype 3 lw 2   lc rgb '#000000' ps 2  pt 3  title 'PyTorch check point',\
        data u 6:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#0000ff' ps 2  pt 9  title 'Python Dynamo',\
        data u 7:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#0000ff' ps 2  pt 3  title 'Python TorchScript',\
        data u 8:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#ff0000' ps 2  pt 9  title 'C++ Dynamo',\
        data u 9:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#ff0000' ps 2  pt 3  title 'C++ TorchScript'
#+end_src

#+RESULTS:
[[file:./thesis/results/images/ONNX-Type-Inference-Languages.png]]

*** Retraining
#+tblname: ONNX-Retraining-Time
| Nr | Phase       | Python | PyTorch |   C++ |
|----+-------------+--------+---------+-------|
|  1 | 40-Ondevice |   1206 |    4245 | 49680 |
|  2 | 40-Resume   |   1462 |    4258 | 48600 |
|  3 | 60-Ondevice |    531 |     939 | 21360 |
|  4 | 60-Resume   |   2344 |    6388 | 69000 |

#+begin_src gnuplot :var data=ONNX-Retraining-Time :missing "?"  :file ./thesis/results/images/ONNX-Retraining-Time.png :exports none
  reset
  set terminal pngcairo enhanced size 800,600 

  set title "Retraining for different partition-retraining strategies with PyTorch, Python and C++"  font ", 13"
  set size ratio square
  set key box linestyle -2 font ", 14"
  set key at graph 0.3, 0.8
  set key textcolor variable
  set xlabel "Partition-Retraining strategy" font ",14" offset 1, -1
  set xtics nomirror rotate by -15  font ", 14"


  set logscale y 2 
  set yrange [256:70000]
  set ylabel "Time consumption of retraining in minutes" font ",14" offset -1, 1
  set ytics nomirror rotate by -25 font ", 12"
  set style data lines
  plot  data u 3:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#000000' ps 2  pt 1  title 'Python',\
        data u 4:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#ff0000' ps 2  pt 9  title 'PyTorch',\
        data u 5:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#0000ff' ps 2  pt 3  title 'C++'
#+end_src

#+RESULTS:
[[file:./thesis/results/images/ONNX-Retraining-Time.png]]

* Federated Learning framework

In order to explor the interoperability of ONNX further, we introduce federated learning use case. Compare to centerlized federated learning, which communicate the updated weights, federated learning with ONNX is more flexible and robust. The following the illustratation of federated learning framework can explain our research case. This design also works for other federated learning AI projects. Its implementation can be done in different languages, however the complete implementation of this design has not been included in my thesis, we are now only foucsing on the on-device learning parts.

#+BEGIN_CENTER
#+ATTR_LaTeX: :height 0.55\textwidth :center
[[../results/drawio/FederLearning.drawio.png]]
#+END_CENTER

This image illustrate the ONNX workflow between server module and client module. Client module download the ONNX from server module for corresponding use cases. We can upload ONNX back to server for aggregation if needed.

** Description
 This following Picture descript the whole project of Federated Learning Framework. 
#+BEGIN_CENTER
#+ATTR_LaTeX: :height 0.55\textwidth :center
[[../results/drawio/FederLearningF.drawio.png]]
#+END_CENTER

*** Node deployment
Deploying  federated learning freamwork as a node if needed.
*** User register
User has to have a node to register. A node can host mulitple users.
*** Project create
After User login in, she/he is allowed to create a project. A project has 3 forms.
    - Server and client module
    - Only Server module
    - Only Client module
*** Map relationship  
The map relationship between server module and client module are totally unlimited,
    - one to one
    - one to many
    - many to one
    - many to many
*** Topological connection  
The topological connection of between server module and client module are totally unlimited,
    - in the same project
    - in the same node
    - between different node

** Server module
- Language: Python. Because the conversion of ONNX to on device training artifacts need Python
- Host ONNX
- Host the newest ONNX file for other client module to download.
- Receive ONNX file from other client module and save it to ONNX pool
- ONNX aggregation
- Update the host ONNX with best performance
- Drop bad or posion ONNX

#+begin_export latex
\begin{minted}[escapeinside=||,mathescape=true]{text}
|$\textbf{\textit{Server Module}}$|():
    node initialize()
    model initialize() -> model
    data formation(data formation description) -> data
    model training()
    model validation()
    ONNX generation() -> ONNX
    training artifacts generation() ->  on-device training generatives
    expose (ONNX, on-device training generatives, data formation description)

    for()
        receive ONNXs from client()
        aggregate ONNXs() -> new ONNX
        new ONNX validation()
        new ONNX inference()
        new training artifacts generation() -> new on-device training generatives
        expose(new ONNX, new on-device training generatives, data formation description)

\end{minted}
#+end_export
  
** Client module
- Language: Python, C/C++, Jave......
*** Inference
- [x] Pull ONNX from server client and data construction instruction
   - if this node only has client module, ONNX file can be pull by other server module
- [x] Data formation
- [x] Load ONNX for inference

#+begin_export latex
\begin{minted}[escapeinside=||,mathescape=true]{text}
|$\textbf{\textit{Client Module for inference}}$|():
      node initialize()
      download(ONNX, data formation description )
      model initialize(ONNX) -> model
      data formation(data formation description) -> data
      for use cases:
          model inference (data)
\end{minted}
#+end_export

*** On-device train
- [x] Pull ONNX generatives from server client and data construction instruction
  - if this node only has client module, ONNX file can be pull by other server module
- [x] Data formation
- [x] Load model for training and validation
- [x] Export ONNX file and save check point
- Upload ONNX file to server module

#+begin_export latex
\begin{minted}[escapeinside=||,mathescape=true]{text}
|$\textbf{\textit{Client Module for ondevice training}}$|():
      node initialize()
      download(on-device training generatives, data formation description)
      model initialize(on-device training generatives) -> model
      data formation(data formation description) -> data
      for use cases:
          model on-device training(data)
          model validation (data)
          ONNX generation() -> ONNX
          upload ONNX to server()
\end{minted}
#+end_export

* Interoperablility between different languages
** Unshuffle40
|--------+--------+--------+--------+--------+--------+--------+--------+--------+-------------+----------+--------------+--------+-------------+--------+--------+--------+--------+--------+--------+--------+--------|
| On20_T | On20_A | On40_T | On40_A | Re20_T | Re20_A | Re40_T | Re40_A | Dynamo | Torchscript | Accuracy | *Conversation* | Dynamo | Torchscript | On20_T | On20_A | On40_T | On40_A | Re20_T | Re20_A | Re40_T | Re40_A |
|   40.1 |  0.636 |  39.88 |  0.695 |   39.8 |  0.519 |   39.5 |  0.587 |  25.33 |       22.80 |    0.327 | python       |   4.10 |         1.9 |   19.9 |  0.226 |  19.33 |  0.695 |  19.37 |  0.519 |  19.13 |  0.587 |
|     73 |        |     74 |        |     72 |        |     73 |        |     73 |          85 |          | C            |     74 |          85 |     73 |        |     73 |        |     75 |        |     74 |        |
|     72 |        |     72 |        |     72 |        |     73 |        |     73 |          84 |          | C++          |     81 |          85 |     73 |        |     73 |        |     74 |        |     74 |        |
|  184.4 |        |  184.9 |        |  184.2 |        |  184.8 |        | 184.88 |       185.8 |    0.328 | Rust         |        |             |        |        |        |        |        |        |        |        |
|   78.0 |        |   88.5 |        |  77.35 |  0.519 |   80.5 |  0.587 |   78.5 |        90.6 |    0.327 | Javascript   |        |             |        |        |        |        |        |        |        |        |
|--------+--------+--------+--------+--------+--------+--------+--------+--------+-------------+----------+--------------+--------+-------------+--------+--------+--------+--------+--------+--------+--------+--------|
| On20_T | On20_A | On40_T | On40_A | Re20_T | Re20_A | Re40_T | Re40_A | Dynamo | Torchscript | Accuracy | *Question*     | Dynamo | Torchscript | On20_T | On20_A | On40_T | On40_A | Re20_T | Re20_A | Re40_T | Re40_A |
|   39.5 |  0.226 |   39.7 |  0.243 |   39.2 |  0.208 |   39.3 |  0.219 |   25.2 |        22.7 |    0.154 | python       |    4.0 |         1.8 |  19.35 |  0.226 |  19.01 |  0.243 |  19.48 |  0.208 |  19.01 |  0.215 |
|     72 |        |     74 |        |     72 |        |     73 |        |     72 |          85 |          | C            |     74 |          85 |     74 |        |     74 |        |     74 |        |     72 |        |
|     74 |        |     72 |        |     72 |        |     72 |        |     73 |          84 |          | C++          |     73 |          84 |     72 |        |     73 |        |     74 |        |     78 |        |
|  184.4 |        |  185.3 |        |  184.8 |        |  184.2 |        |  185.2 |       185.7 |          | Rust         |        |             |        |        |        |        |        |        |        |        |
|   86.0 |        |   81.2 |        |     80 |        |     85 |        |   86.1 |        89.4 |          | Javascript   |        |             |        |        |        |        |        |        |        |        |

** Shuffle40
|--------+--------+--------+--------+--------+--------+--------+--------+--------+-------------+----------+--------------+--------+-------------+--------+--------+--------+--------+--------+--------+--------+--------|
| On20_T | On20_A | On40_T | On40_A | Re20_T | Re20_A | Re40_T | Re40_A | Dynamo | Torchscript | Accuracy | *Conversation* | Dynamo | Torchscript | On20_T | On20_A | On40_T | On40_A | Re20_T | Re20_A | Re40_T | Re40_A |
|  40.43 |  0.652 |  39.49 |  0.698 |   39.5 |  0.523 |  39.59 |  0.583 |   25.5 |        23.2 |    0.329 | Python       |   4.05 |        1.85 |  19.10 |  0.652 |  19.22 |  0.698 |  19.50 |  0.523 |  19.62 |  0.583 |
|     74 |        |     72 |        |     74 |        |     88 |        |     74 |          85 |          | C            |     74 |          85 |     74 |        |     73 |        |     72 |        |     73 |        |
|     73 |        |     72 |        |     73 |        |     73 |        |     72 |          83 |          | C++          |     73 |          85 |     73 |        |     74 |        |     74 |        |     75 |        |
|  184.6 |        |  185.1 |        |  184.2 |        | 184.59 |        |  185.3 |      185.49 |          | Rust         |        |             |        |        |        |        |        |        |        |        |
|   81.2 |        |  83.79 |        |   77.4 |        |   82.9 |        |   79.8 |       90.18 |          | Javascript   |        |             |        |        |        |        |        |        |        |        |
|--------+--------+--------+--------+--------+--------+--------+--------+--------+-------------+----------+--------------+--------+-------------+--------+--------+--------+--------+--------+--------+--------+--------|
| On20_T | On20_A | On40_T | On40_A | Re20_T | Re20_A | Re40_T | Re40_A | Dynamo | Torchscript | Accuracy | *Question*     | Dynamo | Torchscript | On20_T | On20_A | On40_T | On40_A | Re20_T | Re20_A | Re40_T | Re40_A |
|  39.74 |  0.229 |  39.46 |   0.25 |   39.7 |   0.21 |  39.32 |  0.219 |   25.2 |        22.6 |    0.170 | Python       |   4.04 |        1.85 |  20.44 |  0.229 |  19.82 |   0.25 |  19.85 |   0.21 |  19.92 |  0.219 |
|     74 |        |     73 |        |     73 |        |     73 |        |     72 |          85 |          | C            |     73 |          85 |     74 |        |     73 |        |     74 |        |     73 |        |
|     75 |        |     73 |        |     74 |        |     72 |        |     72 |          84 |          | C++          |     73 |          84 |     73 |        |     74 |        |     75 |        |     75 |        |
|  184.9 |        |  184.6 |        | 184.37 |        | 184.68 |        | 185.19 |      185.68 |          | Rust         |        |             |        |        |        |        |        |        |        |        |
|  78.34 |        |  79.86 |        |  85.07 |        |  82.01 |        |  76.79 |        88.2 |          | Javascript   |        |             |        |        |        |        |        |        |        |        |

** Shuffle60
|--------+--------+--------+--------+--------+--------+--------+--------+--------+-------------+----------+--------------+--------+-------------+--------+--------+--------+--------+--------+--------+--------+--------|
| On20_T | On20_A | On40_T | On40_A | Re20_T | Re20_A | Re40_T | Re40_A | Dynamo | Torchscript | Accuracy | *Conversation* | Dynamo | Torchscript | On20_T | On20_A | On40_T | On40_A | Re20_T | Re20_A | Re40_T | Re40_A |
|  41.09 |  0.476 |  39.47 |  0.575 |  39.79 |  0.630 |  39.48 |  0.672 |  25.46 |       23.35 |    0.381 | Python       |   3.96 |        1.80 |  19.12 |  0.476 |  19.42 |  0.575 |  19.33 |  0.630 |  19.35 |  0.672 |
|     73 |  0.476 |     92 |  0.575 |     73 |  0.630 |     74 |  0.672 |     73 |          86 |    0.388 | C            |     89 |          85 |     76 |  0.476 |     75 |  0.575 |     76 |  0.630 |     74 |  0.672 |
|     72 |  0.476 |     72 |  0.575 |     73 |  0.630 |     75 |  0.672 |     74 |          87 |    0.388 | C++          |     72 |          84 |     75 |  0.476 |     73 |  0.575 |     73 |  0.630 |     76 |  0.672 |
| 185.35 |  0.477 | 186.11 |  0.575 |  185.5 |  0.630 | 185.47 |  0.673 |  185.0 |       185.5 |    0.389 | Rust         | 186.15 |      186.22 |        |        |        |        |        |        |        |        |
| 101.18 |  0.476 |  82.52 |  0.575 |  84.83 |   0.63 |  81.99 |  0.672 |   77.4 |        89.3 |    0.388 | Javascript   |  80.16 |       93.54 |        |        |        |        |        |        |        |        |
|--------+--------+--------+--------+--------+--------+--------+--------+--------+-------------+----------+--------------+--------+-------------+--------+--------+--------+--------+--------+--------+--------+--------|
| On20_T | On20_A | On40_T | On40_A | Re20_T | Re20_A | Re40_T | Re40_A | Dynamo | Torchscript | Accuracy | *Question*     | Dynamo | Torchscript | On20_T | On20_A | On40_T | On40_A | Re20_T | Re20_A | Re40_T | Re40_A |
|  19.90 |  0.204 |  19.83 |  0.215 |  19.90 |  0.214 |  19.84 |  0.219 |  25.85 |       22.94 |    0.174 | Python       |   4.00 |        1.83 |  40.08 |  0.204 |  39.96 |  0.216 |  39.68 |  0.214 |  39.40 |  0.219 |
|     74 |  0.204 |     76 |  0.215 |     72 |  0.214 |     73 |  0.219 |     78 |          86 |    0.176 | C            |     75 |          85 |     75 |  0.204 |     73 |  0.215 |     86 |  0.214 |     74 |  0.219 |
|     73 |  0.204 |     73 |  0.215 |     73 |  0.214 |     72 |  0.219 |     76 |          85 |    0.176 | C++          |     72 |          83 |     73 |  0.204 |     74 |  0.215 |     74 |  0.214 |     74 |  0.219 |
| 184.64 |  0.204 | 184.47 |  0.216 | 184.62 |  0.214 | 184.82 |  0.219 |  185.2 |       185.3 |    0.176 | Rust         | 186.99 |      186.88 |        |        |        |        |        |        |        |        |
|  82.49 |  0.204 |  83.63 |  0.215 |  87.03 |  0.214 |  89.14 |  0.219 |   80.0 |       90.73 |    0.176 | Javascript   |  87.39 |       90.77 |        |        |        |        |        |        |        |        |

** Unshuffle60
|--------+--------+--------+--------+--------+--------+--------+--------+--------+-------------+----------+--------------+--------+-------------+--------+--------+--------+--------+--------+--------+--------+--------|
| On20_T | On20_A | On40_T | On40_A | Re20_T | Re20_A | Re40_T | Re40_A | Dynamo | Torchscript | Accuracy | *Conversation* | Dynamo | Torchscript | On20_T | On20_A | On40_T | On40_A | Re20_T | Re20_A | Re40_T | Re40_A |
|  39.46 |  0.436 |  39.82 |  0.548 |   39.4 |  0.617 |  39.15 |  0.657 |   25.4 |        23.6 |     0.37 | Python       |   4.01 |        1.83 |   19.9 |  0.436 |   19.3 |  0.548 |  19.23 |  0.617 |   19.7 |  0.657 |
|     75 |  0.436 |     75 |  0.548 |     74 |  0.617 |     99 |  0.657 |     80 |          87 |    0.379 | C            |     75 |          85 |     73 |  0.436 |     75 |  0.548 |     75 |  0.617 |     76 |  0.657 |
|     79 |  0.436 |     74 |  0.548 |     74 |  0.617 |     74 |  0.657 |     72 |          86 |    0.379 | C++          |        |             |        |        |        |        |        |        |        |        |
|  184.4 |  0.436 | 183.91 |  0.549 |    184 |  0.618 | 184.11 |  0.657 |    184 |         185 |    0.379 | Rust         |        |             |        |        |        |        |        |        |        |        |
|   86.3 |  0.436 |   77.8 |  0.548 |   81.0 |  0.617 |   89.6 |  0.657 |  81.35 |       91.38 |    0.379 | Javascript   |        |             |        |        |        |        |        |        |        |        |
|--------+--------+--------+--------+--------+--------+--------+--------+--------+-------------+----------+--------------+--------+-------------+--------+--------+--------+--------+--------+--------+--------+--------|
| On20_T | On20_A | On40_T | On40_A | Re20_T | Re20_A | Re40_T | Re40_A | Dynamo | Torchscript | Accuracy | *Question*     | Dynamo | Torchscript | On20_T | On20_A | On40_T | On40_A | Re20_T | Re20_A | Re40_T | Re40_A |
|  39.21 |  0.207 |  39.07 |  0.208 |  39.39 |  0.203 |  39.98 |  0.211 |   25.7 |        23.0 |    0.164 | Python       |   4.04 |        1.89 |  20.53 |  0.207 |  20.11 |  0.208 |  20.05 |  0.203 |  20.01 |  0.211 |
|     75 |  0.207 |     73 |  0.208 |     75 |  0.203 |     74 |  0.211 |     78 |          85 |    0.169 | C            |     73 |          86 |     74 |  0.207 |     74 |  0.208 |     74 |  0.203 |     74 |  0.211 |
|     72 |  0.207 |     73 |  0.208 |     73 |  0.203 |     74 |  0.211 |     73 |          84 |    0.169 | C++          |        |             |        |        |        |        |        |        |        |        |
|  184.3 |  0.208 | 184.45 |  0.208 |  184.5 |  0.203 |  184.3 |  0.211 |  183.9 |       185.8 |    0.170 | Rust         |        |             |        |        |        |        |        |        |        |        |
|  82.94 |  0.207 |   82.6 |  0.208 |   86.2 |  0.203 |   78.2 |  0.211 |   85.3 |        94.3 |    0.169 | Javascript   |        |             |        |        |        |        |        |        |        |        |

** Rust
|-------------------------------------------|
| target/release/myonnx  1 60  conversation |
| target/release/myonnx  2 60  conversation |
| target/release/myonnx  3 60  conversation |
| target/release/myonnx  4 60  conversation |
| target/release/myonnx  5 60  conversation |
| target/release/myonnx  6 60  conversation |
| target/release/myonnx  1 60  question     |
| target/release/myonnx  2 60  question     |
| target/release/myonnx  7 60  question     |
| target/release/myonnx  8 60  question     |
| target/release/myonnx  9 60  question     |
| target/release/myonnx  10 60 question     |

** Node
|---------------------------|
| node . 1 60 conversation  |
| node . 2  60 conversation |
| node . 3  60 conversation |
| node . 4  60 conversation |
| node . 5  60 conversation |
| node . 6  60 conversation |
| node . 1  60 question     |
| node . 2  60 question     |
| node . 7  60 question     |
| node . 8  60 question     |
| node . 9  60 question     |
| node . 10 60 question     |
|---------------------------|

** Plot
#+tblname: Interoperablility-ONNX-2-Type
| ONNX | Time  | C-D | C++-D | Python-D | Rust-D |  JS-D | C-T | C++-T | Python-T | Rust-T |  JS-T | Python-D-GPU | Python-T-GPU |
|------+-------+-----+-------+----------+--------+-------+-----+-------+----------+--------+-------+--------------+--------------|
|    1 | Un40Q |  72 |    73 |     25.2 |  185.2 |  86.1 |  85 |    84 |     22.7 |  185.7 |  89.4 |          4.0 |          1.8 |
|    2 | Un60Q |  78 |    73 |     25.7 |  183.9 |  85.3 |  85 |    84 |     23.0 |  185.8 |  94.3 |         4.04 |         1.89 |
|    3 | Sh40Q |  72 |    72 |     25.2 |  185.2 |  76,8 |  85 |    84 |     22.6 |  185.7 |  88.2 |         4.05 |         1.85 |
|    4 | Sh60Q |  78 |    76 |    25.85 |  185.2 |    80 |  86 |    85 |    22.94 |  185.3 |  90.7 |         4.00 |         1.83 |
|    5 | Un40C |  73 |    73 |     25.3 |  184.8 |  78.5 |  85 |    84 |     22.8 |  185.8 |  90.6 |          4.1 |          1.9 |
|    6 | Un60C |  80 |    72 |     25.4 |    184 | 81.35 |  87 |    86 |     23.6 |    185 | 91.38 |         3.96 |         1.83 |
|    7 | Sh40C |  74 |    72 |     25.5 |  185.3 |  79.8 |  85 |    83 |     23.2 |  185.5 |  90.2 |         4.04 |         1.85 |
|    8 | Sh60C |  73 |    74 |    25.35 |    185 |  77.4 |  86 |    87 |    23.35 |  185.5 |  89.3 |         4.01 |         1.83 |

#+begin_src gnuplot :var data=Interoperablility-ONNX-2-Type :missing "?"  :file ../results/images/Interoperablility-ONNX-2-Type.png :exports none
  reset
  set terminal pngcairo enhanced size 800,800
  set multiplot layout 3, 1 

  set title "Time comsumption for ONNX inference for multiple languages"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 14"
  set key at graph 0.87, 0.95
  set key textcolor variable
  set key maxrows 3

  set ytics nomirror rotate by -45 font ", 14"
  set yrange [180:190]
  set xlabel ""
  unset xtics
  plot  data u 6:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#0000dd' ps 2  pt 1  title 'Rust Dynamo CPU',\
        data u 11:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#0000dd' ps 2  pt 1  title 'Rust TorchScript CPU'

  set title ""

  set yrange [70:110]
  set style data lines
  set xlabel ""   
  plot  data u 3:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#000000' ps 2  pt 1  title 'C Dynamo CPU',\
        data u 4:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#dd0000' ps 2  pt 1  title 'C++ Dynamo CPU',\
        data u 7:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#0088ff' ps 2  pt 1  title 'JS Dynamo CPU',\
        data u 8:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#000000' ps 2  pt 1  title 'C TorchScript CPU',\
        data u 9:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#dd0000' ps 2  pt 1  title  'C++ TorchScript CPU',\
        data u 12:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#0088ff' ps 2  pt 1  title 'JS TorchScript CPU'


  set key at graph 0.95, 0.7
  set xlabel "Data: Shuffle-Partation-Evaluation" font ",16" offset 1, -1
  set xtics nomirror rotate by -65  font ", 14"
  set title ""
  set ylabel ""
  set yrange [0:30]
  set style data lines
  plot   data u 13:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#000088' ps 2  pt 1  title 'Python Dynamo GPU',\
         data u 14:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#000088' ps 2  pt 1  title 'Python TorchScript GPU',\
         data u 5:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#008800' ps 2  pt 1  title 'Python Dynamo CPU',\
         data u 10:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#008800' ps 2  pt 1  title 'Python TorchScript CPU'

  unset multiplot 
#+end_src

#+RESULTS:
[[file:../results/images/Interoperablility-ONNX-2-Type.png]]

#+tblname: Interoperablility-ONNX-Resume
| Resume | Data  | C20 | C++20 | Python20 | Rust20 |  JS20 | C40 | C++40 | Python40 | Rust40 |  JS40 | Python20GPU | Python40GPU |
|--------+-------+-----+-------+----------+--------+-------+-----+-------+----------+--------+-------+-------------+-------------|
|      1 | Un40Q |  72 |    72 |     39.2 |  184.2 | 77.35 |  73 |    73 |     39.5 |  184.8 |  80.5 |       19.37 |       19.13 |
|      2 | Un60Q |  75 |    73 |    39.39 |  184.5 |  86.2 |  74 |    74 |    39.98 |  184.3 |  78.2 |       20.05 |          20 |
|      3 | Sh40Q |  73 |    74 |     39.7 | 184.37 |    85 |  73 |    72 |    39.32 | 184.68 |    82 |       19.85 |       19.92 |
|      4 | Sh60Q |  72 |    73 |    39.68 | 184.62 |    87 |  73 |    72 |     39.4 | 184.82 |  89.1 |        19.9 |       19.84 |
|      5 | Un40C |  72 |    72 |     39.8 |  184.2 | 77.35 |  73 |    73 |     39.5 | 184.88 |  80.5 |       19.37 |       19.13 |
|      6 | Un60C |  74 |    74 |     39.4 |    184 |    81 |  79 |    74 |    39.15 |  184.1 |  89.6 |       19.23 |        19.7 |
|      7 | Sh40C |  74 |    73 |     39.5 |  184.2 |  77.4 |  78 |    73 |    39.59 | 184.59 |  82.9 |        19.5 |       19.62 |
|      8 | Sh60C |  73 |    73 |    39.79 |  185.5 |  84.8 |  74 |    75 |    39.48 | 185.47 | 81.99 |       19.33 |       19.35 |

#+begin_src gnuplot :var data=Interoperablility-ONNX-Resume :missing "?"  :file ../results/images/Interoperablility-ONNX-Resume.png :exports none
  reset
  set terminal pngcairo enhanced size 800,800
  set multiplot layout 3, 1 

  set title "Time comsumption of inference for resume trained ONNX with multiple languages"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 12"
  set key at graph 0.68, 0.95
  set key textcolor variable
  set key maxrows 3

  set ytics nomirror rotate by -45 font ", 14"
  set yrange [182:188]
  set xlabel ""
  unset xtics
  plot  data u 6:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#0000dd' ps 2  pt 1  title 'Rust 20 Epochs CPU',\
        data u 11:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#0000dd' ps 2  pt 1  title 'Rust 40 Epochs CPU'

  set title ""

  set yrange [70:100]
  set style data lines
  set xlabel ""   
  plot  data u 3:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#000000' ps 2  pt 1  title 'C 20 Epochs CPU',\
        data u 4:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#dd0000' ps 2  pt 1  title 'C++ 20 Epochs CPU',\
        data u 7:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#0088ff' ps 2  pt 1  title 'JS 20 Epochs CPU',\
        data u 8:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#000000' ps 2  pt 1  title 'C 40 Epochs CPU',\
        data u 9:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#dd0000' ps 2  pt 1  title  'C++ 40 Epochs CPU',\
        data u 12:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#0088ff' ps 2  pt 1  title 'JS 40 Epochs CPU'


  set key at graph 0.95, 0.7
  set xlabel "Data: Shuffle-Partation-Evaluation" font ",16" offset 1, -1
  set xtics nomirror rotate by -65  font ", 14"
  set title ""
  set ylabel ""
  set yrange [15:45]
  set style data lines
  plot   data u 13:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#000088' ps 2  pt 1  title 'Python 20 Epochs GPU',\
         data u 14:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#000088' ps 2  pt 1  title 'Python 40 Epochs GPU',\
         data u 5:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#008800' ps 2  pt 1  title 'Python 20 Epochs CPU',\
         data u 10:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#008800' ps 2  pt 1  title 'Python 40 Epochs CPU'

  unset multiplot 
#+end_src

#+RESULTS:
[[file:../results/images/Interoperablility-ONNX-Resume.png]]


#+tblname: Interoperablility-ONNX-Ondevice
| On-device | Data  | C20 | C++20 | Python20 | Rust20 |   JS20 | C40 | C++40 | Python40 | Rust40 |  JS40 | Python20GPU | Python40GPU |
|-----------+-------+-----+-------+----------+--------+--------+-----+-------+----------+--------+-------+-------------+-------------|
|         1 | Un40Q |  72 |    74 |     39.5 |  184.4 |     86 |  74 |    72 |     39.7 |  185.3 |  81.2 |       19.35 |          19 |
|         2 | Un60Q |  75 |    72 |     39.2 |  184.3 |  82.94 |  73 |    73 |     39.7 | 184.45 | 82.94 |       20.53 |       20.11 |
|         3 | Sh40Q |  74 |    75 |     39.7 |  184.9 |   78.3 |  73 |    73 |    39.46 | 184.37 | 79.86 |       20.44 |       19.82 |
|         4 | Sh60Q |  74 |    73 |    40.08 | 184.64 |  82.49 |  76 |    73 |    39.96 | 184.47 | 83.63 |        19.9 |       19.83 |
|         5 | Un40C |  73 |    72 |     40.1 |  184.4 |     78 |  74 |    72 |    39.88 |  184.9 |  88.5 |        19.9 |       19.33 |
|         6 | Un60C |  75 |    79 |    39.46 |  184.4 |   86.3 |  75 |    74 |    39.82 | 183.91 |  77.8 |        19.9 |        19.3 |
|         7 | Sh40C |  74 |    73 |    40.43 |  184.6 |   81.2 |  72 |    72 |    39.49 |  185.1 | 83.79 |        19.1 |       19.22 |
|         8 | Sh60C |  73 |    72 |     41.1 | 185.35 | 101.18 |  92 |    72 |    39.47 |  186.1 |  82.5 |       19.12 |       19.42 |

#+begin_src gnuplot :var data=Interoperablility-ONNX-Ondevice :missing "?"  :file ../results/images/Interoperablility-ONNX-Ondevice.png :exports none
  reset
  set terminal pngcairo enhanced size 800,800
  set multiplot layout 3, 1 

  set title "Time comsumption of inference for ondevice trained ONNX with multiple languages"  font ", 14"
  set size ratio square
  set key box linestyle -2 font ", 12"
  set key at graph 0.68, 0.95
  set key textcolor variable
  set key maxrows 3

  set ytics nomirror rotate by -45 font ", 14"
  set yrange [182:188]
  set xlabel ""
  unset xtics
  plot  data u 6:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#0000dd' ps 2  pt 1  title 'Rust 20 Epochs CPU',\
        data u 11:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#0000dd' ps 2  pt 1  title 'Rust 40 Epochs CPU'

  set title ""

  set yrange [70:105]
  set style data lines
  set xlabel ""   
  plot  data u 3:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#000000' ps 2  pt 1  title 'C 20 Epochs CPU',\
        data u 4:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#dd0000' ps 2  pt 1  title 'C++ 20 Epochs CPU',\
        data u 7:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#0088ff' ps 2  pt 1  title 'JS 20 Epochs CPU',\
        data u 8:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#000000' ps 2  pt 1  title 'C 40 Epochs CPU',\
        data u 9:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#dd0000' ps 2  pt 1  title  'C++ 40 Epochs CPU',\
        data u 12:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#0088ff' ps 2  pt 1  title 'JS 40 Epochs CPU'


  set key at graph 0.95, 0.7
  set xlabel "Data: Shuffle-Partation-Evaluation" font ",16" offset 1, -1
  set xtics nomirror rotate by -65  font ", 14"
  set title ""
  set ylabel ""
  set yrange [15:45]
  set style data lines
  plot   data u 13:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#000088' ps 2  pt 1  title 'Python 20 Epochs GPU',\
         data u 14:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#000088' ps 2  pt 1  title 'Python 40 Epochs GPU',\
         data u 5:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 1 lw 2   lc rgb '#008800' ps 2  pt 1  title 'Python 20 Epochs CPU',\
         data u 10:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 2   lc rgb '#008800' ps 2  pt 1  title 'Python 40 Epochs CPU'

  unset multiplot 
#+end_src

#+RESULTS:
[[file:../results/images/Interoperablility-ONNX-Ondevice.png]]

* Environments configuration
** Conda 
#+begin_src sh
  module load anaconda3, gcc/9.3, python3.10
  conda create -n onnx python=3.10
  pip install dependencies
  pip list --format=freeze >> requirements.txt
  srun -p grete:shared --pty -n 1 -c 64 -t 24:00:00 -G A100:1 bash
  python -m spacy download de_core_news_sm
  python -m torch_ort.configure
  ipython
#+end_src

#+begin_src python
  import nltk
  nltk.download("punkt")
  nltk.download("stopwords")
#+end_src
      
** Cuda vs cudnn 
#+begin_src shell
  ldconfig -p | grep libcudnn
#+end_src
| torch-ORT      | cuda 11.8 | cuda 12.1 | cuda 12.2 | cuda 12.4 |
|----------------+-----------+-----------+-----------+-----------|
| training model | X         | Y         | X         | X         |


| PYTHON            | cuda 11.8 | cuda 12.1 | cuda 12.2 | cuda 12.4 |
|-------------------+-----------+-----------+-----------+-----------|
| training model    | Y         | Y         | Y         | Y         |
| testing ONNX      | Y         | Y         |           |           |
| ondevice training | Y         | Y         |           |           |
| ONNX inferencing  | Y         | Y         |           |           |



| C++               | device | cuda 11.8 | cuda 12.1 | cuda 12.2 | cuda 12.4 |
|-------------------+--------+-----------+-----------+-----------+-----------|
| testing ONNX      | gpu    |           |           |           |           |
| ondevice training | gpu    |           |           |           |           |
| ONNX inferencing  | gpu    |           |           |           |           |

** Solved problems
- Idential shuffling map between data and label
- Idential content check for Q and C
- Deterministic Pytorch result  
- Deterministic ONNX result
- ONNX result collapse for all input
- ONNX learning rate reconfiguation
** Onnx dependencies
#+begin_src sh :results output :exports none
  export C_INCLUDE_PATH=$C_INCLUDE_PATH:/home/si/Dropbox/masterthesisCS/onnxruntime/onnxruntime18training/include
  export CPLUS_INCLUDE_PATH=$C_INCLUDE_PATH:/home/si/Dropbox/masterthesisCS/onnxruntime/onnxruntime18training/include
  export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/home/si/Dropbox/masterthesisCS/onnxruntime/onnxruntime18training/lib
#+end_src

#+RESULTS:

* Resource consumption
|--------+----------+---------------+---------------|
| phase  | training | onnx ondevice | onnx resuming |
| python |     1460 |          4696 |          4696 |
|        |          |               |               |
* Inference
** Accuracy variant  for inference
#+attr_comment: 2A -> 20 Epoch validation with PyTorch
#+attr_comment: 2B -> 20 Epoch test saved model with PyTorch
#+attr_comment: 2C -> 20 Epoch test with ONNX in Python
#+attr_comment: 2D -> 20 Epoch test with ONNX in PyTorch
#+attr_comment: 2E -> 20 Epoch test with ONNX in Tensorflow
#+attr_comment: 4A -> 40 Epoch validation with PyTorch
#+attr_comment: 4B -> 40 Epoch test with aved model with PyTorch
#+attr_comment: 4C -> 40 Epoch test with ONNX in Python
#+attr_comment: 4D -> 40 Epoch test with ONNX in PyTorch
#+attr_comment: 4E -> 40 Epoch test with ONNX in Tensorflow
#+attr_comment: 4A -> 60 Epoch validation with PyTorch
#+attr_comment: 4B -> 60 Epoch test with aved model with PyTorch
#+attr_comment: 4C -> 60 Epoch test with ONNX in Python
#+attr_comment: 4D -> 60 Epoch test with ONNX in PyTorch
#+attr_comment: 4E -> 60 Epoch test with ONNX in Tensorflow
#+tblname: Inference-accuracy-summary
|----+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------|
| Nr | Data  |   A2A |   B2B |   C2C |   D2D |   E2E |    A4 |   B4B |   C4C |   D4D |   E4E |   A6A |   B6B |   C6C |   D6D |   E6E |
|----+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------|
|  1 | Sh60C | 0.396 | 0.382 | 0.381 | 0.382 | 0.382 | 0.481 | 0.474 | 0.474 | 0.474 | 0.474 | 0.546 | 0.542 | 0.541 | 0.541 | 0.541 |
|  2 | Un60C | 0.391 | 0.379 | 0.373 | 0.373 | 0.373 | 0.452 | 0.467 | 0.444 | 0.445 | 0.445 | 0.525 | 0.522 | 0.514 | 0.515 | 0.515 |
|  3 | Sh40C | 0.345 | 0.330 | 0.329 | 0.330 | 0.330 | 0.379 | 0.355 | 0.355 | 0.355 | 0.355 | 0.407 | 0.376 | 0.376 | 0.376 | 0.376 |
|  4 | Un40C | 0.341 | 0.328 | 0.328 | 0.328 | 0.328 | 0.380 | 0.346 | 0.346 | 0.346 | 0.346 | 0.397 | 0.368 | 0.368 | 0.368 | 0.368 |
|  5 | Sh60Q | 0.177 | 0.174 | 0.174 | 0.174 | 0.174 | 0.189 | 0.191 | 0.192 | 0.192 | 0.192 | 0.190 | 0.185 | 0.185 | 0.186 | 0.186 |
|  6 | Un60Q | 0.174 | 0.170 | 0.165 | 0.165 | 0.165 | 0.193 | 0.191 | 0.188 | 0.188 | 0.188 | 0.197 | 0.195 | 0.201 | 0.201 | 0.201 |
|  7 | Sh40Q | 0.164 | 0.171 | 0.171 | 0.171 | 0.171 | 0.193 | 0.199 | 0.199 | 0.199 | 0.199 | 0.210 | 0.215 | 0.215 | 0.215 | 0.215 |
|  8 | Un40Q | 0.165 | 0.154 | 0.154 | 0.154 | 0.154 | 0.188 | 0.188 | 0.188 | 0.188 | 0.188 | 0.195 | 0.205 | 0.205 | 0.205 | 0.205 |

#+begin_src gnuplot :var data=Inference-accuracy-summary :missing "?"  :file ~/Desktop/inference-accuracy-summary.png :exports none
  reset
  set terminal pngcairo enhanced size 2400,800

  # Set multiplot with 1 row and 3 columns, and an overall title.
  set multiplot layout 1,3 title "Inference accuracy variant of ONNX and PyTorch model after 20, 40 and 60 epochs" font ",14"

  ##############################################
  # Panel 1: 20 Epochs (columns 3 to 7)
  ##############################################
  set title "20 Epochs" font ",14"
  set size ratio square
  set key box linestyle -2 font ",10"
  set key at graph 0.97, 0.95
  set key textcolor variable
  set key maxrows 15
  set key font "Arial,12"
  set ytics nomirror rotate by -45 font ",13"
  set xlabel "Parted dataset according to shuffle-partation-evaluation strategy" font ",14" offset 1,-1
  set yrange [0.15:0.6]

  plot data u 4:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1.5 lc rgb '#000000' ps 2 pt 1 title '20-PyTorch-Inference',\
       data u 5:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1.5 lc rgb '#00ff00' ps 2 pt 1 title '20-ONNX-ONNXRuntime',\
       data u 6:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1.5 lc rgb '#0000ff' ps 2 pt 1 title '20-ONNX-PyTorch',\
       data u 7:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1.5 lc rgb '#ff8800' ps 2 pt 1 title '20-ONNX-Tensorflow'

  ##############################################
  # Panel 2: 40 Epochs (columns 8 to 12)
  ##############################################
  set title "40 Epochs" font ",14"
  set yrange [0.15:0.6]
  # (Other settings remain the same from panel 1)
  plot data u 9:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1.5 lc rgb '#000000' ps 2 pt 1 title '40-PyTorch-Inference',\
       data u 10:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1.5 lc rgb '#00ff00' ps 2 pt 1 title '40-ONNX-ONNXRuntime',\
       data u 11:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1.5 lc rgb '#0000ff' ps 2 pt 1 title '40-ONNX-PyTorch',\
       data u 12:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1.5 lc rgb '#ffdd00' ps 2 pt 1 title '40-ONNX-Tensorflow'

  ##############################################
  # Panel 3: 60 Epochs (columns 13 to 17)
  ##############################################
  set title "60 Epochs" font ",14"
  set yrange [0.15:0.6]
  plot data u 14:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1.5 lc rgb '#000000' ps 2 pt 1 title '60-PyTorch-Inference',\
       data u 15:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1.5 lc rgb '#00ff00' ps 2 pt 1 title '60-ONNX-ONNXRuntime',\
       data u 16:xticlabels(2) with lp axis x1y1 lt 1 dashtype 1 lw 1.5 lc rgb '#0000ff' ps 2 pt 1 title '60-ONNX-PyTorch',\
       data u 17:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1.5 lc rgb '#ffdd00' ps 2 pt 1 title '60-ONNX-Tensorflow'

  unset multiplot

#+end_src

#+RESULTS:
[[file:~/Desktop/inference-accuracy-summary.png]]


** Accuracy variant  for inference together
#+tblname: Inference-accuracy-summary-sep
|----+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------|
| Nr | Data  |   A2A |   B2B |   C2C |   D2D |   E2E |    A4 |   B4B |   C4C |   D4D |   E4E |   A6A |   B6B |   C6C |   D6D |   E6E | Q     |   A2A |   B2B |   C2C |   D2D |   E2E |    A4 |   B4B |   C4C |   D4D |   E4E |   A6A |   B6B |   C6C |   D6D |   E6E |
|----+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------|
|  1 | Sh60C | 0.396 | 0.382 | 0.381 | 0.382 | 0.382 | 0.481 | 0.474 | 0.474 | 0.474 | 0.474 | 0.546 | 0.542 | 0.541 | 0.541 | 0.541 | Sh60Q | 0.177 | 0.174 | 0.174 | 0.174 | 0.174 | 0.189 | 0.192 | 0.192 | 0.192 | 0.192 | 0.190 | 0.186 | 0.186 | 0.186 | 0.186 |
|  2 | Un60C | 0.391 | 0.379 | 0.379 | 0.379 | 0.379 | 0.452 | 0.467 | 0.467 | 0.467 | 0.467 | 0.525 | 0.522 | 0.522 | 0.522 | 0.522 | Un60Q | 0.174 | 0.170 | 0.170 | 0.170 | 0.170 | 0.193 | 0.191 | 0.191 | 0.191 | 0.191 | 0.197 | 0.195 | 0.195 | 0.195 | 0.195 |
|  3 | Sh40C | 0.345 | 0.330 | 0.329 | 0.330 | 0.330 | 0.379 | 0.355 | 0.355 | 0.355 | 0.355 | 0.407 | 0.376 | 0.376 | 0.376 | 0.376 | Sh40Q | 0.164 | 0.171 | 0.171 | 0.171 | 0.171 | 0.193 | 0.199 | 0.199 | 0.199 | 0.199 | 0.210 | 0.215 | 0.215 | 0.215 | 0.215 |
|  4 | Un40C | 0.341 | 0.328 | 0.328 | 0.328 | 0.328 | 0.380 | 0.346 | 0.346 | 0.346 | 0.346 | 0.397 | 0.368 | 0.368 | 0.368 | 0.368 | Un40Q | 0.165 | 0.154 | 0.154 | 0.154 | 0.154 | 0.188 | 0.188 | 0.188 | 0.188 | 0.188 | 0.195 | 0.205 | 0.205 | 0.205 | 0.205 |
#+begin_src gnuplot :var data=Inference-accuracy-summary-sep :missing "?"  :file ~/Desktop/inference-accuracy-summary-all.png :exports none
    reset
    set terminal pngcairo enhanced size 1600,800
    set multiplot layout 1,2  title "Inference accuracy of saved PyTorch model and ONNX in PyTorch, Tensorflow and ONNX Runtime"  font ", 14"
    set tmargin at screen 0.90

    set size ratio square
    set key box linestyle -2 font ", 12"
    set key at graph 0.99, 0.95
    set key textcolor variable
    set key maxrows 3
    set key horizontal font "Arial,12"
    set ytics nomirror rotate by -45 font ", 12"


    set title ""
    set yrange [0.3:0.6]
    set xlabel "Parted dataset according to shuffle-partation strategy for conversation" font ",13" offset 1, -1
    plot   data u  4:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#8B0000' ps 2  pt 1  title '20-PyTorch-Inference',\
           data u  5:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#FF0000' ps 2  pt 1  title '20-ONNX-Runtime',\
           data u  6:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#FF4444' ps 2  pt 1  title '20-ONNX-PyTorch',\
           data u  7:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#FF6666' ps 2  pt 1  title '20-ONNX-Tensorflow',\
           data u  9:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#002000' ps 2  pt 1  title '40-PyTorch-Inference',\
           data u 10:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#006000' ps 2  pt 1  title '40-ONNX-Runtime',\
           data u 11:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#009900' ps 2  pt 1  title '40-ONNX-PyTorch',\
           data u 12:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#00ff00' ps 2  pt 1  title '40-ONNX-Tensorflow',\
           data u 14:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#00008B' ps 2  pt 1  title '60-PyTorch-Inference',\
           data u 15:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#0000FF' ps 2  pt 1  title '60-ONNX-Runtime',\
           data u 16:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#4444FF' ps 2  pt 1  title '60-ONNX-PyTorch',\
           data u 17:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 1.5   lc rgb '#6666FF' ps 2  pt 1  title '60-ONNX-Tensorflow'

    set yrange [0.15:0.22]
    set style data lines
    set key at graph 1.0, 0.48
   set title ""
    set xlabel "Parted dataset according to shuffle-partation strategy for question" font ",13" offset 1, -1
    plot   data u 20:xticlabels(18)  with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#8B0000' ps 2  pt 1  title '20-PyTorch-Inference',\
           data u 21:xticlabels(18)  with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#FF0000' ps 2  pt 1  title '20-ONNX-Runtime',\
           data u 22:xticlabels(18)  with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#FF4444' ps 2  pt 1  title '20-ONNX-PyTorch',\
           data u 23:xticlabels(18)  with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#FF6666' ps 2  pt 1  title '20-ONNX-Tensorflow',\
           data u 25:xticlabels(18)  with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#002000' ps 2  pt 1  title '40-PyTorch-Inference',\
           data u 26:xticlabels(18)  with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#006000' ps 2  pt 1  title '40-ONNX-Runtime',\
           data u 27:xticlabels(18)  with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#009900' ps 2  pt 1  title '40-ONNX-PyTorch',\
           data u 28:xticlabels(18)  with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#00ff00' ps 2  pt 1  title '40-ONNX-Tensorflow',\
           data u 30:xticlabels(18)  with lp axis x1y1 lt 1 dashtype 2 lw 1.5   lc rgb '#00008B' ps 2  pt 1  title '60-PyTorch-Inference',\
           data u 31:xticlabels(18)  with lp axis x1y1 lt 1 dashtype 2 lw 1.5   lc rgb '#0000FF' ps 2  pt 1  title '60-ONNX-Runtime',\
           data u 32:xticlabels(18)  with lp axis x1y1 lt 1 dashtype 2 lw 1.5   lc rgb '#4444FF' ps 2  pt 1  title '60-ONNX-PyTorch',\
           data u 33:xticlabels(18)  with lp axis x1y1 lt 1 dashtype 2 lw 1.5   lc rgb '#6666FF' ps 2  pt 1  title '60-ONNX-Tensorflow'

   unset multiplot 
#+end_src

#+RESULTS:
[[file:~/Desktop/inference-accuracy-summary-all.png]]




** Time consumption difference for inference
#+tblname: time-consumption-difference-inference
| ONNX | Time  | C-D | C++-D | Python-D | Rust-D |  JS-D | C-T | C++-T | Python-T | Rust-T |  JS-T | Python-D-GPU | Python-T-GPU | PyTorch | Tensorflow |
|------+-------+-----+-------+----------+--------+-------+-----+-------+----------+--------+-------+--------------+--------------+---------+------------|
|    1 | Un40Q |  72 |    73 |     25.2 |  185.2 |  86.1 |  85 |    84 |     22.7 |  185.7 |  89.4 |          4.0 |          1.8 |   19.68 |      41.92 |
|    2 | Un60Q |  78 |    73 |     25.7 |  183.9 |  85.3 |  85 |    84 |     23.0 |  185.8 |  94.3 |         4.04 |         1.89 |   19.76 |      40.27 |
|    3 | Sh40Q |  72 |    72 |     25.2 |  185.2 |  76,8 |  85 |    84 |     22.6 |  185.7 |  88.2 |         4.05 |         1.85 |   20.51 |      41.70 |
|    4 | Sh60Q |  78 |    76 |    25.85 |  185.2 |    80 |  86 |    85 |    22.94 |  185.3 |  90.7 |         4.00 |         1.83 |   19.03 |      39.01 |
|    5 | Un40C |  73 |    73 |     25.3 |  184.8 |  78.5 |  85 |    84 |     22.8 |  185.8 |  90.6 |          4.1 |          1.9 |   19.62 |      38.78 |
|    6 | Un60C |  80 |    72 |     25.4 |    184 | 81.35 |  87 |    86 |     23.6 |    185 | 91.38 |         3.96 |         1.83 |   18.95 |      40.45 |
|    7 | Sh40C |  74 |    72 |     25.5 |  185.3 |  79.8 |  85 |    83 |     23.2 |  185.5 |  90.2 |         4.04 |         1.85 |   19.11 |      38.80 |
|    8 | Sh60C |  73 |    74 |    25.35 |    185 |  77.4 |  86 |    87 |    23.35 |  185.5 |  89.3 |         4.01 |         1.83 |   19.83 |      40.56 |

#+begin_src gnuplot :var data=time-consumption-difference-inference :missing "?"  :file ~/Desktop/time-consumption-difference-inference.png :exports none
  reset
  set terminal pngcairo enhanced size 800,800
  set multiplot layout 4, 1 

  set title "Time consumption difference for TorchScript/Dynamo ONNX"  font ", 13"
  set size ratio square
  set key box linestyle -2 font ", 12"
  set key at graph 0.87, 0.95
  set key textcolor variable
  set key maxrows 3
  set key horizontal font "Arial,12"
  set ytics nomirror rotate by -45 font ", 12"
  

  set yrange [182:188]
  set xlabel ""
  unset xtics
  plot  data u 6:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#000000' ps 2  pt 1  title 'Rust Dynamo CPU',\
        data u 11:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1.5   lc rgb '#0000dd' ps 2  pt 1  title 'Rust TorchScript CPU'

  set title ""

  set yrange [70:105]
  set style data lines
  set xlabel ""
  set key at graph 0.99, 0.99
  plot  data u 3:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#000000' ps 2  pt 1  title 'C Dynamo CPU',\
        data u 8:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 1.5   lc rgb '#000000' ps 2  pt 1  title 'C TorchScript CPU',\
        data u 4:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#dd0000' ps 2  pt 1  title 'C++ Dynamo CPU',\
        data u 9:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 1.5   lc rgb '#dd0000' ps 2  pt 1  title  'C++ TorchScript CPU',\
        data u 7:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#0088ff' ps 2  pt 1  title 'JS Dynamo CPU',\
        data u 12:xticlabels(2) with lp axis x1y1 lt 1 dashtype 2 lw 1.5   lc rgb '#0088ff' ps 2  pt 1  title 'JS TorchScript CPU'

  set title ""
  set ylabel ""
  set yrange [18:44]
  set style data lines
  set key at graph 0.90, 0.70
  plot   data u 5:xticlabels(2)   with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#ff0000' ps 2  pt 1  title 'Python Dynamo CPU',\
         data u 10:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 1.5   lc rgb '#000000' ps 2  pt 1  title 'Python TorchScript CPU',\
         data u 15:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 1.5   lc rgb '#ff00ff' ps 2  pt 1  title 'PyTorch TorchScript CPU',\
         data u 16:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 1.5   lc rgb '#006666' ps 2  pt 1  title 'Tensorflow TorchScript CPU'


  set key at graph 0.95, 0.7
  set xlabel "Parted dataset according to shuffle-partation-evaluation strategy" font ",13" offset 1, -1
  set xtics nomirror rotate by -65  font ", 12"
  set title ""
  set ylabel ""
  set yrange [0:5]
  set style data lines
  plot   data u 13:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 1 lw 1.5   lc rgb '#1111dd' ps 2  pt 1  title 'Python Dynamo GPU',\
         data u 14:xticlabels(2)  with lp axis x1y1 lt 1 dashtype 2 lw 1.5   lc rgb '#000000' ps 2  pt 1  title 'Python TorchScript GPU'

  unset multiplot 
#+end_src

#+RESULTS:
[[file:~/Desktop/time-consumption-difference-inference.png]]


